<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>project_specific_ipynb_code.reproducing_L6paper &mdash; In-Silico Framework (ISF) 0.0.1 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            In-Silico Framework (ISF)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/Interface.html">Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/SLURM_scripts.html">SLURM_scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/barrel_cortex.html">barrel_cortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/biophysics_fitting.html">biophysics_fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/compatibility.html">compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/getting_started.html">getting_started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/mechanisms.html">mechanisms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/model_data_base.html">model_data_base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/nbrun.html">nbrun</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/project_specific_ipynb_code.html">project_specific_ipynb_code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/simrun2.html">simrun2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/simrun3.html">simrun3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/single_cell_analyzer.html">single_cell_analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/single_cell_parser.html">single_cell_parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/singlecell_input_mapper.html">singlecell_input_mapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/spike_analysis.html">spike_analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/tests.html">tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/visualize.html">visualize</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">In-Silico Framework (ISF)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">project_specific_ipynb_code.reproducing_L6paper</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for project_specific_ipynb_code.reproducing_L6paper</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;THis module contains code to facilitate computations in the ipynb files that </span>
<span class="sd">contain the name &#39;_reproducing_L6paper_ in /nas1/Data_arco/notebooks&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">Interface</span> <span class="k">as</span> <span class="nn">I</span>
<span class="kn">from</span> <span class="nn">simrun2.reduced_model.get_kernel</span> <span class="kn">import</span> <span class="n">compare_lists_by_none_values</span>
<span class="kn">from</span> <span class="nn">single_cell_parser.network_param_modify_functions</span> <span class="kn">import</span> <span class="n">set_stim_onset</span>
<span class="kn">from</span> <span class="nn">single_cell_parser.network_param_modify_functions</span> <span class="kn">import</span> <span class="n">change_ongoing_interval</span>
<span class="kn">from</span> <span class="nn">single_cell_parser</span> <span class="kn">import</span> <span class="n">network</span>
<span class="kn">import</span> <span class="nn">biophysics_fitting.utils</span>
<span class="kn">from</span> <span class="nn">biophysics_fitting.hay_evaluation</span> <span class="kn">import</span> <span class="n">objectives_BAC</span><span class="p">,</span> <span class="n">objectives_step</span>
<span class="kn">import</span> <span class="nn">simrun3.utils</span>
<span class="kn">import</span> <span class="nn">simrun3.synaptic_strength_fitting</span>
<span class="kn">import</span> <span class="nn">six</span>


<span class="c1">###########################</span>
<span class="c1"># setting up model data base</span>
<span class="c1">###########################</span>

<div class="viewcode-block" id="L6config"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.L6config">[docs]</a><span class="k">class</span> <span class="nc">L6config</span><span class="p">:</span>
<div class="viewcode-block" id="L6config.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.L6config.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">mdb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">biophysical_model_mdb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">biophysical_model_mdb_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">anatomical_model_mdb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">anatomical_model_mdb_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">hocpath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">runs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">locs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C2center&#39;</span><span class="p">,</span> <span class="s1">&#39;C1border&#39;</span><span class="p">,</span> <span class="s1">&#39;C3border&#39;</span><span class="p">,</span> <span class="s1">&#39;B1border&#39;</span><span class="p">,</span> <span class="s1">&#39;B2border&#39;</span><span class="p">,</span> <span class="s1">&#39;B3border&#39;</span><span class="p">,</span> <span class="s1">&#39;D1border&#39;</span><span class="p">,</span> <span class="s1">&#39;D2border&#39;</span><span class="p">,</span> <span class="s1">&#39;D3border&#39;</span><span class="p">],</span>
                 <span class="n">stims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">,</span> <span class="s1">&#39;B2&#39;</span><span class="p">,</span> <span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">,</span> <span class="s1">&#39;D3&#39;</span><span class="p">,</span> <span class="s1">&#39;E2&#39;</span><span class="p">]):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">mdb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">biophysical_model_mdb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">biophysical_model_mdb_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">anatomical_model_mdb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>        
        <span class="k">assert</span><span class="p">(</span><span class="n">runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">hocpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biophysical_model_mdb</span> <span class="o">=</span> <span class="n">biophysical_model_mdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biophysical_model_mdb_key</span> <span class="o">=</span> <span class="n">biophysical_model_mdb_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_model_mdb</span> <span class="o">=</span> <span class="n">anatomical_model_mdb</span> 
        <span class="k">if</span> <span class="n">anatomical_model_mdb_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_model_mdb_key</span> <span class="o">=</span> <span class="n">anatomical_model_mdb_key</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_model_mdb_key</span> <span class="o">=</span> <span class="n">biophysical_model_mdb_key</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">runs</span> <span class="o">=</span> <span class="n">runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hocpath</span> <span class="o">=</span> <span class="n">hocpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="n">stims</span></div>
        
<div class="viewcode-block" id="L6config.setup_mdb"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.L6config.setup_mdb">[docs]</a>    <span class="k">def</span> <span class="nf">setup_mdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;copies all files at the appropriate location in this mdb&#39;&#39;&#39;</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;morphology&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;copying morphology </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hocpath</span><span class="p">))</span>
            <span class="n">mdb</span><span class="o">.</span><span class="n">create_managed_folder</span><span class="p">(</span><span class="s1">&#39;morphology&#39;</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hocpath</span><span class="p">,</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">])</span>
        

        <span class="c1"># copying this, because we might have a different morpholgy here compared to the </span>
        <span class="c1"># biophysics fitting, which might be incompatzible with the confile.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">,</span><span class="s1">&#39;get_Combiner&#39;</span><span class="p">,</span><span class="s1">&#39;get_Evaluator&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;get_Simulator&#39;</span><span class="p">,</span><span class="s1">&#39;get_fixed_params&#39;</span><span class="p">,</span><span class="s1">&#39;params&#39;</span><span class="p">]:</span>
            <span class="n">mdb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biophysical_model_mdb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">biophysical_model_mdb_key</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;network_embedding&#39;</span>  <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;create network embedding subfolder&#39;</span><span class="p">)</span>
            <span class="n">mdb</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">)</span>     
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;creating network_embedding subfolder for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>
                <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_managed_folder</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
               
        <span class="k">def</span> <span class="nf">get_file_or_folder_that_startswith</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">startswith</span><span class="p">):</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">startswith</span><span class="p">)]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">def</span> <span class="nf">get_file_or_folder_that_endswith</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">endswith</span><span class="p">):</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">endswith</span><span class="p">)]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;creating number of cells spreadsheet from confile&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">singlecell_input_mapper.singlecell_input_mapper</span> <span class="kn">import</span> <span class="n">con_file_to_NumberOfConnectedCells_sheet</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locs</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anatomical_model_mdb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomical_model_mdb_key</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">get_file_or_folder_that_startswith</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">loc</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">syn</span> <span class="o">=</span> <span class="n">get_file_or_folder_that_endswith</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;.syn&#39;</span><span class="p">)</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">get_file_or_folder_that_endswith</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;.con&#39;</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;con.syn&#39;</span><span class="p">))</span>
            <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;con.con&#39;</span><span class="p">))</span>
            <span class="n">con_file_to_NumberOfConnectedCells_sheet</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;con.con&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> 
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>            
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;create evoked activity parameterfiles&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">getting_started</span> <span class="kn">import</span> <span class="n">getting_started_dir</span>
        <span class="n">ongoing_template_param_name</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">getting_started_dir</span><span class="p">,</span> <span class="s1">&#39;functional_constraints/ongoing_activity/ongoing_activity_celltype_template_exc_conductances_fitted.param&#39;</span><span class="p">)</span>               
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;template: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ongoing_template_param_name</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">stim: </span><span class="si">{}</span><span class="s1">, loc: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span><span class="n">loc</span><span class="p">))</span>
                <span class="n">ongoing_template_param_name</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">getting_started_dir</span><span class="p">,</span> <span class="s1">&#39;functional_constraints/ongoing_activity/ongoing_activity_celltype_template_exc_conductances_fitted.param&#39;</span><span class="p">)</span>
                <span class="n">cell_number_file_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;NumberOfConnectedCells.csv&#39;</span><span class="p">)</span>
                <span class="n">syn_file_path</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;con.syn&#39;</span><span class="p">)</span>
                <span class="n">con_file_path</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;con.con&#39;</span><span class="p">)</span>
                <span class="n">cell_number_file_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;NumberOfConnectedCells.csv&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">I</span><span class="o">.</span><span class="n">silence_stdout</span><span class="p">:</span>
                    <span class="n">I</span><span class="o">.</span><span class="n">create_evoked_network_parameter</span><span class="p">(</span><span class="n">ongoing_template_param_name</span><span class="p">,</span> 
                                          <span class="n">cell_number_file_name</span><span class="p">,</span> 
                                          <span class="n">syn_file_path</span><span class="p">,</span> 
                                          <span class="n">con_file_path</span><span class="p">,</span> 
                                          <span class="n">stim</span><span class="p">,</span> 
                                          <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stim</span> <span class="o">+</span> <span class="s1">&#39;_network.param&#39;</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">()</span> </div>
<div class="viewcode-block" id="L6config.get_network_param"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.L6config.get_network_param">[docs]</a>    <span class="k">def</span> <span class="nf">get_network_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;C2center&#39;</span><span class="p">,</span> <span class="n">stim</span> <span class="o">=</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="n">network_param_modfuns</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">stim_onset</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">):</span>
        <span class="n">network_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_network.param&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stim</span><span class="p">))</span>
        <span class="n">network_param</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">build_parameters</span><span class="p">(</span><span class="n">network_param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="n">network_param_modfuns</span><span class="p">:</span>
            <span class="n">fun</span><span class="p">(</span><span class="n">network_param</span><span class="p">)</span>
        <span class="n">set_stim_onset</span><span class="p">(</span><span class="n">network_param</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">network_param</span>  </div></div>
    
        
<span class="c1">#####################</span>
<span class="c1"># model selection</span>
<span class="c1">#####################</span>
<div class="viewcode-block" id="ModelSelection"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection">[docs]</a><span class="k">class</span> <span class="nc">ModelSelection</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39; Handles selection of models and allows analyzing them&#39;&#39;&#39;</span>
<div class="viewcode-block" id="ModelSelection.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l6_config</span><span class="p">,</span> 
                 <span class="n">objectives_BAC</span> <span class="o">=</span> <span class="n">objectives_BAC</span><span class="p">,</span>
                 <span class="n">objectives_step</span> <span class="o">=</span> <span class="n">objectives_step</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span> <span class="o">=</span> <span class="n">l6_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">l6_config</span><span class="o">.</span><span class="n">biophysical_model_mdb</span><span class="p">[</span><span class="n">l6_config</span><span class="o">.</span><span class="n">biophysical_model_mdb_key</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdf_XY_splitted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_XY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pdfXY</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_XY</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectives_BAC</span> <span class="o">=</span> <span class="n">objectives_BAC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectives_step</span> <span class="o">=</span> <span class="n">objectives_step</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_models</span> <span class="o">=</span> <span class="p">[]</span>      </div>
        
    <span class="k">def</span> <span class="nf">_get_pdfXY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">biophysics_fitting.model_selection</span> <span class="kn">import</span> <span class="n">get_model_pdf_from_mdb</span><span class="p">,</span> <span class="n">get_pdf_selected</span>    
        <span class="n">pdf_XY_splitted</span><span class="p">,</span> <span class="n">pdf_XY</span> <span class="o">=</span> <span class="n">get_model_pdf_from_mdb</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">biophysical_model_mdb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">biophysical_model_mdb_key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pdf_XY_splitted</span><span class="p">,</span> <span class="n">pdf_XY</span>
        
    <span class="kn">import</span> <span class="nn">six</span>
<div class="viewcode-block" id="ModelSelection.select_models"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection.select_models">[docs]</a>    <span class="k">def</span> <span class="nf">select_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">BAC_limit</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">,</span> <span class="n">step_limit</span> <span class="o">=</span> <span class="mf">4.5</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">biophysics_fitting.model_selection</span> <span class="kn">import</span> <span class="n">get_model_pdf_from_mdb</span><span class="p">,</span> <span class="n">get_pdf_selected</span>            
        <span class="n">selected_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf_XY_splitted</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">runs</span><span class="p">:</span> <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives_BAC</span><span class="p">)</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">selected_model</span> <span class="o">=</span> <span class="n">get_pdf_selected</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">BAC_limit</span> <span class="o">=</span> <span class="n">BAC_limit</span><span class="p">,</span> <span class="n">step_limit</span> <span class="o">=</span> <span class="n">step_limit</span><span class="p">,</span>
                                                 <span class="n">objectives_BAC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives_BAC</span><span class="p">,</span>
                                                 <span class="n">objectives_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives_step</span><span class="p">)</span>
            <span class="n">selected_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_model</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_models</span> <span class="o">=</span> <span class="n">selected_models</span>  
        <span class="k">return</span> <span class="n">selected_models</span> <span class="c1"># get_pdf_selected(pdf, BAC_limit = 3.5, step_limit = 4.5)</span></div>
    
<div class="viewcode-block" id="ModelSelection.get_parameters"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection.get_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_XY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">modelid</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="ModelSelection.get_objectives"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection.get_objectives">[docs]</a>    <span class="k">def</span> <span class="nf">get_objectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;group: all, BAC or step&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span>
        <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;BAC&#39;</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives_BAC</span>
        <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives_step</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_XY</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">modelid</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">]</span></div>

<div class="viewcode-block" id="ModelSelection.get_cell_param"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection.get_cell_param">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">add_sim_param</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">recordingSites</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">tStop</span> <span class="o">=</span> <span class="mi">295</span><span class="p">):</span>
        <span class="n">simulator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_simulator</span><span class="p">()</span>
        <span class="n">cell_param</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">get_cell_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">modelid</span><span class="p">))</span> 
        <span class="k">if</span> <span class="n">add_sim_param</span><span class="p">:</span>
            <span class="n">cell_param</span> <span class="o">=</span> <span class="n">_add_sim_to_neuron_param</span><span class="p">(</span><span class="n">cell_param</span><span class="p">,</span> 
                                                  <span class="n">recordingSites</span> <span class="o">=</span> <span class="n">recordingSites</span><span class="p">,</span> 
                                                  <span class="n">tStop</span> <span class="o">=</span> <span class="n">tStop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cell_param</span></div>
    
<div class="viewcode-block" id="ModelSelection.get_simulator"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection.get_simulator">[docs]</a>    <span class="k">def</span> <span class="nf">get_simulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span> <span class="c1"># biophysical_model_mdb[self.l6_config.biophysical_model_mdb_key]</span>
        <span class="k">return</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;get_Simulator&#39;</span><span class="p">](</span><span class="n">mdb</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="ModelSelection.get_cell_with_biophysics"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelSelection.get_cell_with_biophysics">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_with_biophysics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_simulator</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">modelid</span><span class="p">))</span></div></div>
    

<span class="c1">##################</span>
<span class="c1"># simulate and visualize model responses</span>
<span class="c1">###################</span>
<div class="viewcode-block" id="o"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.o">[docs]</a><span class="k">class</span> <span class="nc">o</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;object opaque for dask. Allows passing sumatra.NTParameter structures.</span>
<span class="sd">    They don&#39;t get serialized propely by dask otherwise&#39;&#39;&#39;</span>
<div class="viewcode-block" id="o.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.o.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span></div></div>

<div class="viewcode-block" id="get_ax_ids"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_ax_ids">[docs]</a><span class="k">def</span> <span class="nf">get_ax_ids</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;takes list of list specifying the arangement of subplots.</span>
<span class="sd">    returns tuples, such that matplotlib axes are arranged in the same way</span>
<span class="sd">    </span>
<span class="sd">    ll = [[&#39;upper left&#39;,&#39;upper right&#39;],[&#39;lower left&#39;,&#39;lower mid&#39;,&#39;lower right&#39;]]</span>
<span class="sd">    get_ax_ids(ll)</span>
<span class="sd">    {(2, 2, 1): &#39;upper left&#39;,</span>
<span class="sd">     (2, 2, 2): &#39;upper right&#39;,</span>
<span class="sd">     (2, 3, 4): &#39;lower left&#39;,</span>
<span class="sd">     (2, 3, 5): &#39;lower mid&#39;,</span>
<span class="sd">     (2, 3, 6): &#39;lower right&#39;}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">{(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">linenr</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="n">colnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">col</span>
            <span class="k">for</span> <span class="n">linenr</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">colnr</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">)}</span></div>
    
         
<div class="viewcode-block" id="ModelResponses"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelResponses">[docs]</a><span class="k">class</span> <span class="nc">ModelResponses</span><span class="p">:</span>
<div class="viewcode-block" id="ModelResponses.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelResponses.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelSelection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span> <span class="o">=</span> <span class="n">modelSelection</span></div>
    
    <span class="k">def</span> <span class="nf">_save_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="n">modelid</span><span class="p">,</span> <span class="n">raise_</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="s1">&#39;model_responses&#39;</span><span class="p">,</span> <span class="n">raise_</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>        
        <span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">raise_</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">mdb</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">dumper</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">dumper_cell</span><span class="p">)</span>
        <span class="n">mdb</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="s1">&#39;tVec&#39;</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">tVec</span><span class="p">),</span> <span class="n">dumper</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">dumper_numpy_to_npz</span><span class="p">)</span>
        <span class="n">mdb</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="s1">&#39;vmSoma&#39;</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">soma</span><span class="o">.</span><span class="n">recVList</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dumper</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">dumper_numpy_to_npz</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_save_return_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">return_cell</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">stim</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_cell</span><span class="p">(</span><span class="n">modelid</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_cell</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cell</span>
        
    <span class="nd">@I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span>
    <span class="k">def</span> <span class="nf">simulate_current_stim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">return_cell</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">get_simulator</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">modelid</span><span class="p">)</span>
        <span class="n">cell</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_simulated_cell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stim</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_return_helper</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">return_cell</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">stim</span><span class="p">)</span>
    
    <span class="nd">@I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span>
    <span class="k">def</span> <span class="nf">simulate_synaptic_stim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">network_param_o</span><span class="p">,</span> 
                               <span class="n">stim_description</span><span class="p">,</span> <span class="n">return_cell</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                               <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">tStop</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">):</span>
        <span class="c1"># dask does not serialize sumatra.NTParameterSet properly, therefore</span>
        <span class="c1"># we encapsulate it</span>
        <span class="n">network_param</span> <span class="o">=</span> <span class="n">network_param_o</span><span class="o">.</span><span class="n">obj</span> 
        <span class="n">cell</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">get_cell_with_biophysics</span><span class="p">(</span><span class="n">modelid</span><span class="p">)</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">NTParameterSet</span><span class="p">({</span><span class="s1">&#39;tStart&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;tStop&#39;</span><span class="p">:</span> <span class="n">tStop</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span> 
                                    <span class="s1">&#39;Vinit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">75.0</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mf">34.0</span><span class="p">})</span>        
        <span class="n">evokedNW</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">NetworkMapper</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">network_param</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">sim</span><span class="p">)</span>
        <span class="n">evokedNW</span><span class="o">.</span><span class="n">create_saved_network2</span><span class="p">()</span>
        <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">init_neuron_run</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">vardt</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_return_helper</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">return_cell</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">stim_description</span><span class="p">)</span>

    <span class="nd">@I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span>
    <span class="k">def</span> <span class="nf">simulate_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">return_cell</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">cell</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">get_cell_with_biophysics</span><span class="p">(</span><span class="n">modelid</span><span class="p">)</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">NTParameterSet</span><span class="p">({</span><span class="s1">&#39;tStart&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;tStop&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span> 
                                    <span class="s1">&#39;Vinit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">75.0</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mf">34.0</span><span class="p">})</span>       
        <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">init_neuron_run</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">vardt</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_return_helper</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">return_cell</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">)</span>
        
<div class="viewcode-block" id="ModelResponses.run_simulation_for_selected_models"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelResponses.run_simulation_for_selected_models">[docs]</a>    <span class="k">def</span> <span class="nf">run_simulation_for_selected_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="n">selected_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">selected_models</span>
        <span class="n">delayeds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">simulate_current_stim</span><span class="p">(</span><span class="n">modelid</span><span class="p">,</span> <span class="n">stim</span><span class="p">)</span> 
                    <span class="k">for</span> <span class="n">modelid</span> <span class="ow">in</span> <span class="n">selected_models</span>
                    <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">get_simulator</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">get_stims</span><span class="p">()]</span>
        <span class="n">delayeds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">simulate_initialization</span><span class="p">(</span><span class="n">modelid</span><span class="p">)</span> <span class="k">for</span> <span class="n">modelid</span> <span class="ow">in</span> <span class="n">selected_models</span><span class="p">])</span>
        <span class="n">network_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">get_network_param</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;C2center&#39;</span><span class="p">,</span> 
                                                                       <span class="n">stim</span> <span class="o">=</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> 
                                                                       <span class="n">stim_onset</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="n">delayeds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">simulate_synaptic_stim</span><span class="p">(</span><span class="n">modelid</span><span class="p">,</span> <span class="n">o</span><span class="p">(</span><span class="n">network_param</span><span class="p">),</span> <span class="s1">&#39;PW_stim&#39;</span><span class="p">)</span> 
                         <span class="k">for</span> <span class="n">modelid</span> <span class="ow">in</span> <span class="n">selected_models</span><span class="p">])</span>  
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">delayeds</span><span class="p">))</span>      
        <span class="n">futures</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">delayeds</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">fire_and_forget</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">delayeds</span><span class="p">,</span> <span class="n">futures</span></div>
        
    <span class="k">def</span> <span class="nf">_extract_vm_from_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;helper function to extract membrane potential at &#39;important&#39; locations&#39;&#39;&#39;</span>
        <span class="n">l6_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">l6_config</span>
        <span class="n">biophysical_model_mdb</span> <span class="o">=</span> <span class="n">l6_config</span><span class="o">.</span><span class="n">biophysical_model_mdb</span>
        <span class="n">biophysical_model_mdb_key</span> <span class="o">=</span> <span class="n">l6_config</span><span class="o">.</span><span class="n">biophysical_model_mdb_key</span>
        <span class="n">fixed_params</span> <span class="o">=</span> <span class="n">biophysical_model_mdb</span><span class="p">[</span><span class="n">biophysical_model_mdb_key</span><span class="p">][</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">]</span>
        <span class="n">BAC_dist</span> <span class="o">=</span> <span class="n">fixed_params</span><span class="p">[</span><span class="s1">&#39;BAC.stim.dist&#39;</span><span class="p">]</span>
        <span class="n">hot_zone_dist</span> <span class="o">=</span> <span class="n">fixed_params</span><span class="p">[</span><span class="s1">&#39;hot_zone.max_&#39;</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span> <span class="o">+</span> <span class="n">fixed_params</span><span class="p">[</span><span class="s1">&#39;hot_zone.max_&#39;</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span>
        <span class="n">bAP_dist_1</span> <span class="o">=</span> <span class="n">fixed_params</span><span class="p">[</span><span class="s1">&#39;bAP.hay_measure.recSite1&#39;</span><span class="p">]</span>
        <span class="n">bAP_dist_2</span> <span class="o">=</span> <span class="n">fixed_params</span><span class="p">[</span><span class="s1">&#39;bAP.hay_measure.recSite2&#39;</span><span class="p">]</span>    
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;soma&#39;</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">soma</span><span class="o">.</span><span class="n">recVList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;hot_zone&#39;</span><span class="p">:</span> <span class="n">biophysics_fitting</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">vmApical</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">hot_zone_dist</span><span class="p">),</span>
            <span class="s1">&#39;bAP1&#39;</span><span class="p">:</span> <span class="n">biophysics_fitting</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">vmApical</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">bAP_dist_1</span><span class="p">),</span>
            <span class="s1">&#39;AIS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">sections</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;AIS&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">recVList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#&#39;bAP2&#39;: biophysics_fitting.utils.vmApical(cell, 529)</span>
            <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">_plot_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">colormap</span><span class="p">[</span><span class="s1">&#39;hot_zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
        <span class="n">colormap</span><span class="p">[</span><span class="s1">&#39;soma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
        <span class="n">colormap</span><span class="p">[</span><span class="s1">&#39;AIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
        <span class="kn">import</span> <span class="nn">six</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_vm_from_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">tVec</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;AIS&#39;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>        
            
<div class="viewcode-block" id="ModelResponses.visualize_selected_models"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.ModelResponses.visualize_selected_models">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_selected_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax_arrangement</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;PW_stim&#39;</span><span class="p">],</span>
                          <span class="p">[</span><span class="s1">&#39;BAC&#39;</span><span class="p">,</span> <span class="s1">&#39;bAP&#39;</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">],[</span><span class="s1">&#39;StepOne&#39;</span><span class="p">,</span> <span class="s1">&#39;StepTwo&#39;</span><span class="p">,</span> <span class="s1">&#39;StepThree&#39;</span><span class="p">,</span> <span class="p">]],</span>
                            <span class="n">xlim</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BAC&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span><span class="mi">400</span><span class="p">),</span>
                                    <span class="s1">&#39;bAP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span><span class="mi">400</span><span class="p">)},</span>
                            <span class="n">ylim</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">)}):</span>
        <span class="n">selected_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">selected_models</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelSelection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        <span class="kn">import</span> <span class="nn">six</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">selected_models</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">selected_models</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="p">)][</span><span class="s1">&#39;model_responses&#39;</span><span class="p">]</span>         
            <span class="n">fig</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="o">*</span><span class="mf">0.7</span><span class="p">,</span><span class="mi">12</span><span class="o">*.</span><span class="mi">7</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>            
            <span class="k">for</span> <span class="n">ax_position</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">get_ax_ids</span><span class="p">(</span><span class="n">ax_arrangement</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="o">*</span><span class="n">ax_position</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_helper</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">stim</span><span class="p">][</span><span class="s1">&#39;cell&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">xlim</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">[</span><span class="n">stim</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">ylim</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">[</span><span class="n">stim</span><span class="p">])</span>
            <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">I</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
            <span class="n">I</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
            
<span class="c1">###################</span>
<span class="c1"># synaptic strength fitting</span>
<span class="c1">###################</span>

<span class="k">def</span> <span class="nf">_add_sim_to_neuron_param</span><span class="p">(</span><span class="n">neuron_param</span><span class="p">,</span> <span class="n">recordingSites</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">tStop</span> <span class="o">=</span> <span class="mi">295</span><span class="p">):</span>
        <span class="n">NTParameterSet</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">NTParameterSet</span>
        <span class="n">sim_param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tStart&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;tStop&#39;</span><span class="p">:</span> <span class="mi">295</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span> <span class="s1">&#39;Vinit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">75.0</span><span class="p">,</span> 
                     <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mf">34.0</span><span class="p">,</span> <span class="s1">&#39;recordingSites&#39;</span><span class="p">:</span> <span class="n">recordingSites</span><span class="p">}</span>
        <span class="n">NMODL_mechanisms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">NTParameterSet</span><span class="p">({</span><span class="s1">&#39;neuron&#39;</span><span class="p">:</span> <span class="n">neuron_param</span><span class="p">,</span> 
                               <span class="s1">&#39;sim&#39;</span><span class="p">:</span> <span class="n">sim_param</span><span class="p">,</span> 
                               <span class="s1">&#39;NMODL_mechanisms&#39;</span><span class="p">:</span> <span class="n">NMODL_mechanisms</span><span class="p">})</span>
        
<div class="viewcode-block" id="SynapticStrengthFitting"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting">[docs]</a><span class="k">class</span> <span class="nc">SynapticStrengthFitting</span><span class="p">:</span>
<div class="viewcode-block" id="SynapticStrengthFitting.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_selection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span> <span class="o">=</span> <span class="n">model_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psps</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_psp_descriptors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_psps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuron_param</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confile</span> <span class="o">=</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="SynapticStrengthFitting.run_synaptic_strength_fitting"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting.run_synaptic_strength_fitting">[docs]</a>    <span class="k">def</span> <span class="nf">run_synaptic_strength_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;C2center&#39;</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;syn_strength_fitting&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;skipping model </span><span class="si">{}</span><span class="s1"> as it seems to be simulated already. If the simulation &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
                <span class="s1">&#39;run was incomplete, you can delete the data by running del l6_config.mdb[</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;syn_strength_fitting&#39;</span><span class="p">)</span>                
                <span class="k">continue</span>         
            <span class="n">cell_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">get_cell_param</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">cell_param</span> <span class="o">=</span> <span class="n">_add_sim_to_neuron_param</span><span class="p">(</span><span class="n">cell_param</span><span class="p">)</span>
            <span class="n">confile</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;network_embedding&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s1">&#39;.con&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">confile</span> <span class="o">=</span> <span class="n">confile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neuron_param</span> <span class="o">=</span> <span class="n">cell_param</span>
            <span class="n">psp</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">simrun3</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">PSPs</span><span class="p">(</span><span class="n">cell_param</span><span class="p">,</span> <span class="n">confile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">psp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psps</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">psp</span></div>
        
    <span class="kn">import</span> <span class="nn">six</span>
<div class="viewcode-block" id="SynapticStrengthFitting.save_psps_to_mdb"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting.save_psps_to_mdb">[docs]</a>    <span class="k">def</span> <span class="nf">save_psps_to_mdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">psps</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psps</span><span class="p">):</span>
            <span class="n">mdb</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="s1">&#39;syn_strength_fitting&#39;</span><span class="p">,</span> <span class="n">raise_</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">psps</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">psps</span><span class="p">):</span>
                <span class="n">psps</span><span class="o">.</span><span class="n">get_voltage_and_timing</span><span class="p">()</span>
                <span class="n">mdb</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;syn_strength_fitting&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">psps</span></div>
    
<div class="viewcode-block" id="SynapticStrengthFitting.get_psp_from_database"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting.get_psp_from_database">[docs]</a>    <span class="k">def</span> <span class="nf">get_psp_from_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        <span class="n">psp</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="n">modelid</span><span class="p">][</span><span class="s1">&#39;syn_strength_fitting&#39;</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">psp</span></div>
    
<div class="viewcode-block" id="SynapticStrengthFitting.get_optimal_g"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting.get_optimal_g">[docs]</a>    <span class="k">def</span> <span class="nf">get_optimal_g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;C2center&#39;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;dynamic_baseline&#39;</span><span class="p">,</span> <span class="n">threashold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns dataframe containing optimal synaptic strnghts. Assumes, that all voltage</span>
<span class="sd">        traces from synaptic strength fitting are saved in mdb[model_id][syn_strength_fitting_psp]&#39;&#39;&#39;</span>
            
        <span class="c1">#model_id = selected_models[0]</span>
        <span class="n">psp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_psp_from_database</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
        
        <span class="c1">#### fix to add missing kwargs if old version has been pickled</span>
        <span class="c1">#### this could be entirely avoided if the version used for saving the object would be checked out in git</span>
        <span class="c1">#### to figure out the version, inspect the metadata saved in the model data base</span>
        <span class="c1">#### using mdb.metadata[&#39;your_key_to_your_PSP_object&#39;]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">simrun3</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_default_arguments</span><span class="p">(</span><span class="n">simrun3</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">PSPs</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
        <span class="n">simrun3</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_default_arguments_if_not_set</span><span class="p">(</span><span class="n">psp</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#### end of fix    </span>
        
        <span class="n">vt</span> <span class="o">=</span> <span class="n">psp</span><span class="o">.</span><span class="n">get_voltage_and_timing</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">merged</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">simrun3</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">ePSP_summary_statistics</span><span class="p">(</span><span class="n">vt</span><span class="p">,</span>  <span class="n">threashold</span> <span class="o">=</span> <span class="n">threashold</span><span class="p">)</span>
        <span class="n">pdf_linfit</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pdf_linfit</span> <span class="o">=</span> <span class="n">pdf_linfit</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;celltype&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">simrun3</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">linear_fit_pdf</span><span class="p">)</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pdf_linfit</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">barrel_cortex</span><span class="o">.</span><span class="n">get_EPSP_measurement</span><span class="p">()],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">simrun3</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">calculate_optimal_g</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>        
        <span class="k">return</span> <span class="n">pdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;VPM_C2&#39;</span><span class="p">:</span> <span class="s1">&#39;VPM&#39;</span><span class="p">})</span>    </div>
        
<span class="c1">#     def visualize_psps(self, model_id, loc = &#39;C2center&#39;, g = 1.0, method = &#39;dynamic_baseline&#39;):</span>
<span class="c1">#         psp = self.get_psp_from_database(model_id, loc)</span>
<span class="c1">#         vt = psp.get_voltage_and_timing(method)        </span>
<span class="c1">#         #vt = I.simrun3.synaptic_strength_fitting.get_voltage_and_timing(vt, method)</span>
<span class="c1">#         vt = I.simrun3.synaptic_strength_fitting.merge_celltypes(vt) </span>
<span class="c1">#         pdf = I.pd.concat([I.pd.Series([x[1] for x in vt[name][g][g]], name = name) </span>
<span class="c1">#              for name in vt.keys()], axis = 1)</span>
<span class="c1">#         fig = I.plt.figure(figsize = (10,len(vt)*1.3))</span>
<span class="c1">#         ax = fig.add_subplot(111)</span>
<span class="c1">#         pdf.plot(kind = &#39;hist&#39;, subplots = True, bins = I.np.arange(0,pdf.max().max(), 0.01), ax = ax)</span>
<div class="viewcode-block" id="SynapticStrengthFitting.visualize_psps"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting.visualize_psps">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_psps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;C2center&#39;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;dynamic_baseline&#39;</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">psp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_psp_from_database</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
        <span class="n">psp</span><span class="o">.</span><span class="n">visualize_psps</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></div>

                
<div class="viewcode-block" id="SynapticStrengthFitting.save_synapses_to_landmark_file"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.SynapticStrengthFitting.save_synapses_to_landmark_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_synapses_to_landmark_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelid</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;C2center&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">I</span><span class="o">.</span><span class="n">silence_stdout</span><span class="p">:</span>
            <span class="n">cell</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">get_cell_with_biophysics</span><span class="p">(</span><span class="n">modelid</span><span class="p">)</span>
        <span class="n">network_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">get_network_param</span><span class="p">()</span> 
        <span class="n">nwMap</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">NetworkMapper</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">network_param</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">NTParameterSet</span><span class="p">({</span><span class="s1">&#39;tStop&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
        <span class="k">with</span> <span class="n">I</span><span class="o">.</span><span class="n">silence_stdout</span><span class="p">:</span>
            <span class="n">nwMap</span><span class="o">.</span><span class="n">_assign_anatomical_synapses</span><span class="p">()</span>   
            <span class="n">nwMap</span><span class="o">.</span><span class="n">_create_presyn_cells</span><span class="p">()</span>    
        <span class="n">syn_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">synapses</span><span class="p">[</span><span class="n">population</span><span class="p">]]</span>
        <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">write_landmark_file</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">syn_coordinates</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">syn_coordinates</span> </div></div>

<span class="c1">############################################</span>
<span class="c1"># write landmark files</span>
<span class="c1">############################################</span>

<div class="viewcode-block" id="write_landmark_file"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.write_landmark_file">[docs]</a><span class="k">def</span> <span class="nf">write_landmark_file</span><span class="p">(</span><span class="n">model_selection</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">I</span><span class="o">.</span><span class="n">silence_stdout</span><span class="p">:</span>
        <span class="n">cell</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">get_cell_with_biophysics</span><span class="p">(</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">fixed_params</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">]</span>
    
    <span class="n">landmark_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">biophysics_fitting</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">vmApical_position</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span> 
                          <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fixed_params</span><span class="p">[</span><span class="s1">&#39;bAP.hay_measure.recSite1&#39;</span><span class="p">],</span> <span class="n">fixed_params</span><span class="p">[</span><span class="s1">&#39;bAP.hay_measure.recSite2&#39;</span><span class="p">]]]</span> 
    
    <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">write_landmark_file</span><span class="p">(</span><span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span>\
                              <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;recSites.landmarkAscii&#39;</span><span class="p">),</span> <span class="n">landmark_positions</span><span class="p">)</span></div>
<span class="c1">#############################################</span>
<span class="c1"># general method for setting up simulations of evoked activity</span>
<span class="c1">#############################################</span>
<div class="viewcode-block" id="EvokedActivitySimulationSetup"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetup">[docs]</a><span class="k">class</span> <span class="nc">EvokedActivitySimulationSetup</span><span class="p">:</span>
<div class="viewcode-block" id="EvokedActivitySimulationSetup.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetup.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">synaptic_strength_fitting</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">stims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">locs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">INHscalings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tStim</span> <span class="o">=</span> <span class="mi">245</span><span class="p">,</span> <span class="n">tEnd</span> <span class="o">=</span> <span class="mi">295</span><span class="p">,</span>
                 <span class="n">models</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span> <span class="o">=</span> <span class="n">output_dir_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span> <span class="o">=</span> <span class="n">synaptic_strength_fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span> <span class="o">=</span> <span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">model_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="n">stims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INHscaling</span> <span class="o">=</span> <span class="n">INHscalings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tStim</span> <span class="o">=</span> <span class="n">tStim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tEnd</span> <span class="o">=</span> <span class="n">tEnd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span></div>
            
<div class="viewcode-block" id="EvokedActivitySimulationSetup.setup"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetup.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        
        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">syn_strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">get_optimal_g</span><span class="p">(</span><span class="n">model_id</span><span class="p">)[</span><span class="s1">&#39;optimal g&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;syn_strength&#39;</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">syn_strength</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">create_managed_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;skipping model </span><span class="si">{}</span><span class="s1"> as it seems to be simulated already. If the simulation &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_id</span><span class="p">))</span>
                <span class="s1">&#39;run was incomplete, you can delete the data by running del l6_config.mdb[</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">landmark_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;recSites.landmarkAscii&#39;</span><span class="p">)</span>        
            <span class="n">cell_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">get_cell_param</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">add_sim_param</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                        <span class="n">recordingSites</span> <span class="o">=</span> <span class="p">[</span><span class="n">landmark_name</span><span class="p">])</span>
            <span class="n">cell_param_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="s1">&#39;PW_fitting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;cell.param&#39;</span><span class="p">)</span>
            <span class="n">cell_param</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cell_param_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">INH_scaling</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INHscaling</span><span class="p">:</span>            
                <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locs</span><span class="p">:</span>
                        <span class="n">network_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">get_network_param</span><span class="p">(</span><span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="p">,</span> 
                                                                    <span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span><span class="p">,</span> 
                                                                    <span class="n">stim_onset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tStim</span><span class="p">)</span>
                        <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">network_param_modify_functions</span><span class="o">.</span><span class="n">change_evoked_INH_scaling</span><span class="p">(</span><span class="n">network_param</span><span class="p">,</span> <span class="n">INH_scaling</span><span class="p">)</span>
                        <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">network_param_modify_functions</span><span class="o">.</span><span class="n">change_glutamate_syn_weights</span><span class="p">(</span><span class="n">network_param</span><span class="p">,</span> <span class="n">syn_strength</span><span class="p">)</span>
                        <span class="n">network_param_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;network_INH_</span><span class="si">{}</span><span class="s1">_stim_</span><span class="si">{}</span><span class="s1">_loc_</span><span class="si">{}</span><span class="s1">.param&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INH_scaling</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
                        <span class="n">network_param</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">network_param_name</span><span class="p">)</span>
                        <span class="n">outdir</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">INH_scaling</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">INH_scaling</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">simrun_run_new_simulations</span><span class="p">(</span><span class="n">cell_param_name</span><span class="p">,</span> <span class="n">network_param_name</span><span class="p">,</span> 
                                                         <span class="n">dirPrefix</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">,</span> 
                                                         <span class="n">nSweeps</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> 
                                                         <span class="n">nprocs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                                                         <span class="n">scale_apical</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                                                         <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                         <span class="n">tStop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tEnd</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>
<div class="viewcode-block" id="EvokedActivitySimulationSetup.run"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetup.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">fire_and_forget</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You must run the setup method first&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fire_and_forget</span><span class="p">:</span>
            <span class="n">I</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">fire_and_forget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="EvokedActivitySimulationSetup.init_mdb"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetup.init_mdb">[docs]</a>    <span class="k">def</span> <span class="nf">init_mdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">dendritic_voltage_traces</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span><span class="p">:</span>
            <span class="n">mdb_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span> <span class="o">+</span> <span class="s1">&#39;_mdb&#39;</span>
            <span class="k">if</span> <span class="n">mdb_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">del</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="n">mdb_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mdb_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">mdb_init</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="n">mdb_key</span><span class="p">)</span>
                <span class="n">I</span><span class="o">.</span><span class="n">mdb_init_simrun_general</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">mdb_init</span><span class="p">,</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">],</span> 
                                               <span class="n">burst_times</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                                               <span class="n">get</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
                                               <span class="n">dendritic_voltage_traces</span> <span class="o">=</span> <span class="n">dendritic_voltage_traces</span><span class="p">)</span>        </div></div>
            
<div class="viewcode-block" id="EvokedActivitySimulationSetupRieke"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetupRieke">[docs]</a><span class="k">class</span> <span class="nc">EvokedActivitySimulationSetupRieke</span><span class="p">:</span>
<div class="viewcode-block" id="EvokedActivitySimulationSetupRieke.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetupRieke.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">synaptic_strength_fitting</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">stims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">locs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">INHscalings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ongoing_scales</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">ongoing_scales_pop</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">inhibitory</span><span class="p">,</span> 
                 <span class="n">custom_glutamate_conductances</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nProcs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nSweeps</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> 
                 <span class="n">cell_param_modify_functions</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="n">network_param_modify_functions</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="n">tStim</span> <span class="o">=</span> <span class="mi">245</span><span class="p">,</span> 
                 <span class="n">tEnd</span> <span class="o">=</span> <span class="mi">295</span><span class="p">,</span>
                 <span class="n">models</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span> <span class="o">=</span> <span class="n">output_dir_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span> <span class="o">=</span> <span class="n">synaptic_strength_fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span> <span class="o">=</span> <span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">model_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">l6_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="n">stims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INHscaling</span> <span class="o">=</span> <span class="n">INHscalings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ongoing_scales</span> <span class="o">=</span> <span class="n">ongoing_scales</span> <span class="c1">#rieke</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ongoing_scales_pop</span> <span class="o">=</span> <span class="n">ongoing_scales_pop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_glutamate_conductances</span> <span class="o">=</span> <span class="n">custom_glutamate_conductances</span> <span class="c1"># should be pandas dataframe or series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_param_modify_functions</span> <span class="o">=</span> <span class="n">cell_param_modify_functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_param_modify_functions</span> <span class="o">=</span> <span class="n">network_param_modify_functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nProcs</span> <span class="o">=</span> <span class="n">nProcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nSweeps</span> <span class="o">=</span> <span class="n">nSweeps</span> <span class="c1"># /rieke</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tStim</span> <span class="o">=</span> <span class="n">tStim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tEnd</span> <span class="o">=</span> <span class="n">tEnd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span></div>
            
<div class="viewcode-block" id="EvokedActivitySimulationSetupRieke.setup"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetupRieke.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        
        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_glutamate_conductances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">syn_strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_strength_fitting</span><span class="o">.</span><span class="n">get_optimal_g</span><span class="p">(</span><span class="n">model_id</span><span class="p">)[</span><span class="s1">&#39;optimal g&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;syn_strength&#39;</span><span class="p">)</span>
                <span class="n">I</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">syn_strength</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_glutamate_conductances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">syn_strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_glutamate_conductances</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">create_managed_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;skipping model </span><span class="si">{}</span><span class="s1"> as it seems to be simulated already. If the simulation &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;run was incomplete, you can delete the data by running del l6_config.mdb[</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">][</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">landmark_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;recSites.landmarkAscii&#39;</span><span class="p">)</span>        
            <span class="n">cell_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">get_cell_param</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">add_sim_param</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                        <span class="n">recordingSites</span> <span class="o">=</span> <span class="p">[</span><span class="n">landmark_name</span><span class="p">])</span>
            <span class="n">cell_param_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;cell.param&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cell_param_modify_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_param_modify_functions</span><span class="p">:</span>
                <span class="n">cell_param_modify_function</span><span class="p">(</span><span class="n">cell_param</span><span class="p">)</span>
                
            <span class="n">cell_param</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cell_param_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">INH_scaling</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INHscaling</span><span class="p">:</span>   
                <span class="k">for</span> <span class="n">ongoing_scale</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ongoing_scales</span><span class="p">:</span> 
                    <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locs</span><span class="p">:</span>
                            <span class="n">network_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">get_network_param</span><span class="p">(</span><span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="p">,</span> 
                                                                        <span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span><span class="p">,</span> 
                                                                        <span class="n">stim_onset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tStim</span><span class="p">)</span>
                            <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">network_param_modify_functions</span><span class="o">.</span><span class="n">change_evoked_INH_scaling</span><span class="p">(</span><span class="n">network_param</span><span class="p">,</span> <span class="n">INH_scaling</span><span class="p">)</span>
                            <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">network_param_modify_functions</span><span class="o">.</span><span class="n">change_glutamate_syn_weights</span><span class="p">(</span><span class="n">network_param</span><span class="p">,</span> <span class="n">syn_strength</span><span class="p">)</span>
                            <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">network_param_modify_functions</span><span class="o">.</span><span class="n">change_ongoing_interval</span><span class="p">(</span><span class="n">network_param</span><span class="p">,</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">ongoing_scale</span><span class="p">,</span> <span class="n">pop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ongoing_scales_pop</span><span class="p">)</span> <span class="c1">##adjust ongoing activity if necessary</span>
                            <span class="k">for</span> <span class="n">network_param_modify_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_param_modify_functions</span><span class="p">:</span>
                                <span class="n">network_param_modify_function</span><span class="p">(</span><span class="n">network_param</span><span class="p">)</span>                            
                            <span class="n">network_param_name</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;network_INHevoked_</span><span class="si">{}</span><span class="s1">_INHongoing_</span><span class="si">{}</span><span class="s1">_stim_</span><span class="si">{}</span><span class="s1">_loc_</span><span class="si">{}</span><span class="s1">.param&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INH_scaling</span><span class="p">,</span> <span class="n">ongoing_scale</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
                            <span class="n">network_param</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">network_param_name</span><span class="p">)</span>
                            <span class="n">outdir</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ongoing_scale</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">INH_scaling</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">ongoing_scale</span><span class="p">,</span> <span class="n">INH_scaling</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                            
                            <span class="n">d</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">simrun_run_new_simulations</span><span class="p">(</span><span class="n">cell_param_name</span><span class="p">,</span> <span class="n">network_param_name</span><span class="p">,</span> 
                                                             <span class="n">dirPrefix</span> <span class="o">=</span> <span class="n">outdir</span><span class="p">,</span> 
                                                             <span class="n">nSweeps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSweeps</span><span class="p">,</span> 
                                                             <span class="n">nprocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nProcs</span><span class="p">,</span> 
                                                             <span class="n">scale_apical</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                                                             <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                             <span class="n">tStop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tEnd</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>
                            
<div class="viewcode-block" id="EvokedActivitySimulationSetupRieke.run"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetupRieke.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">fire_and_forget</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You must run the setup method first&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fire_and_forget</span><span class="p">:</span>
            <span class="n">I</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">fire_and_forget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="EvokedActivitySimulationSetupRieke.init_mdb"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.EvokedActivitySimulationSetupRieke.init_mdb">[docs]</a>    <span class="k">def</span> <span class="nf">init_mdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">dendritic_voltage_traces</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span><span class="p">:</span>
            <span class="n">mdb_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span> <span class="o">+</span> <span class="s1">&#39;_mdb&#39;</span>
            <span class="k">if</span> <span class="n">mdb_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">del</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="n">mdb_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mdb_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">mdb_init</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)]</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="n">mdb_key</span><span class="p">)</span>
                <span class="n">I</span><span class="o">.</span><span class="n">mdb_init_simrun_general</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">mdb_init</span><span class="p">,</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir_key</span><span class="p">],</span> 
                                               <span class="n">burst_times</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                                               <span class="n">get</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
                                               <span class="n">dendritic_voltage_traces</span> <span class="o">=</span> <span class="n">dendritic_voltage_traces</span><span class="p">)</span>    </div></div>
<span class="c1">############</span>
<span class="c1"># PW fitting</span>
<span class="c1">############</span>

<div class="viewcode-block" id="signchange"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.signchange">[docs]</a><span class="k">def</span> <span class="nf">signchange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>
<span class="k">assert</span><span class="p">(</span><span class="n">signchange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="k">assert</span><span class="p">(</span><span class="o">~</span><span class="n">signchange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="k">assert</span><span class="p">(</span><span class="o">~</span><span class="n">signchange</span><span class="p">(</span><span class="o">-</span><span class="mi">22</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="k">assert</span><span class="p">(</span><span class="n">signchange</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="o">-</span><span class="mi">1789</span><span class="p">))</span>

<div class="viewcode-block" id="linear_interpolation_between_pairs"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.linear_interpolation_between_pairs">[docs]</a><span class="k">def</span> <span class="nf">linear_interpolation_between_pairs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="c1">#     assert(x&lt;=max(X))</span>
<span class="c1">#     assert(x&gt;=min(X))</span>
<span class="c1">#     pair = [lv for lv in range(len(X)-1) if signchange(X[lv]-x, X[lv+1]-x)]</span>
<span class="c1">#     assert(len(pair) == 1)</span>
<span class="c1">#     pair = pair[0]</span>
<span class="c1">#     m = (Y[pair+1]-Y[pair]) / (X[pair+1]-X[pair])</span>
<span class="c1">#     c = Y[pair]-X[pair]*m</span>
<span class="c1">#     return m*x+c </span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">):</span> <span class="c1"># if the value already exists</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">X</span> <span class="o">==</span> <span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="p">[</span><span class="n">lv</span> <span class="k">for</span> <span class="n">lv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">X</span><span class="p">[</span><span class="n">lv</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">X</span><span class="p">[</span><span class="n">lv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
     
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">pair</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Y</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">pair</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">X</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">-</span><span class="n">X</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">*</span><span class="n">m</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">c</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PWfitting"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.PWfitting">[docs]</a><span class="k">class</span> <span class="nc">PWfitting</span><span class="p">:</span>
<div class="viewcode-block" id="PWfitting.__init__"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.PWfitting.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l6_config</span><span class="p">,</span> <span class="n">model_selection</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">mdb_path1</span> <span class="o">=</span> <span class="s1">&#39;/nas1/Data_arco/results/20190114_spiketimes_database&#39;</span><span class="p">,</span> <span class="n">mdb_path2</span> <span class="o">=</span> <span class="s1">&#39;/nas1/Data_arco/results/mdb_robert_3x3/&#39;</span><span class="p">,</span> <span class="n">stim</span> <span class="o">=</span> <span class="s1">&#39;D2&#39;</span><span class="p">,</span> <span class="n">cellid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span> <span class="o">=</span> <span class="n">l6_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span> <span class="o">=</span> <span class="n">model_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">min_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdb_path1</span> <span class="o">=</span> <span class="n">mdb_path1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdb_path2</span> <span class="o">=</span> <span class="n">mdb_path2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span>
        <span class="k">if</span> <span class="n">cellid</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cellid</span> <span class="o">=</span> <span class="n">l6_config</span><span class="o">.</span><span class="n">biophysical_model_mdb_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cellid</span> <span class="o">=</span> <span class="n">cellid</span>
        <span class="c1">### get target value</span>
        <span class="c1">#st_CDK = I.ModelDataBase(&#39;/nas1/Data_arco/results/20190114_spiketimes_database&#39;)[&#39;CDK_PassiveTouch&#39;] # rieke</span>
        <span class="n">st_CDK</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">ModelDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb_path1</span><span class="p">)[</span><span class="s1">&#39;CDK_PassiveTouch&#39;</span><span class="p">]</span>
        
        <span class="n">st_CDK</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">st_CDK</span><span class="p">,</span> <span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span> <span class="c1">#changed by rieke</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CDK_target_value_avg_L5tt</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">st_CDK</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="n">min_time</span><span class="p">,</span> 
                                                       <span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span><span class="p">,</span> 
                                                       <span class="n">bin_size</span> <span class="o">=</span> <span class="n">max_time</span><span class="o">-</span><span class="n">min_time</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CDK_target_value_same_cell</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">st_CDK</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellid</span><span class="p">),</span> 
                                                      <span class="n">min_time</span> <span class="o">=</span> <span class="n">min_time</span><span class="p">,</span> 
                                                             <span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span><span class="p">,</span> 
                                                             <span class="n">bin_size</span> <span class="o">=</span> <span class="n">max_time</span><span class="o">-</span><span class="n">min_time</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CDK_target_value_avg_L5tt: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CDK_target_value_avg_L5tt</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CDK_target_value_same_cell: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CDK_target_value_same_cell</span><span class="p">))</span>
        
        <span class="c1">#st_robert_control = I.ModelDataBase(&#39;/nas1/Data_arco/results/mdb_robert_3x3/&#39;)[&#39;spike_times&#39;]</span>
        <span class="n">st_robert_control</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">ModelDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb_path2</span><span class="p">)[</span><span class="s1">&#39;spike_times&#39;</span><span class="p">]</span>
        
        <span class="n">st_robert_control</span> <span class="o">=</span> <span class="n">st_robert_control</span><span class="p">[</span><span class="n">st_robert_control</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_robert</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">st_robert_control</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="n">min_time</span><span class="p">,</span> 
                                                <span class="n">max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="n">max_time</span><span class="p">,</span> 
                                                <span class="n">bin_size</span> <span class="o">=</span> <span class="n">max_time</span><span class="o">-</span><span class="n">min_time</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;target_robert: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_robert</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_get_INH_dependent_n_spikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="p">)][</span><span class="s1">&#39;PW_fitting_mdb&#39;</span><span class="p">][</span><span class="s1">&#39;spike_times&#39;</span><span class="p">]</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;INH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
                                           <span class="n">min_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">min_time</span><span class="p">,</span> 
                                           <span class="n">max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">,</span> 
                                           <span class="n">bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_time</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;INH&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">return</span> <span class="n">s</span>
    
<div class="viewcode-block" id="PWfitting.plot_INH_pspike_relationship"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.PWfitting.plot_INH_pspike_relationship">[docs]</a>    <span class="k">def</span> <span class="nf">plot_INH_pspike_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>


        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;pink&#39;</span><span class="p">]</span>
        <span class="n">model_color</span> <span class="o">=</span> <span class="p">[[</span><span class="n">model</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">lv</span><span class="p">]]</span> 
                       <span class="k">for</span> <span class="n">lv</span><span class="p">,</span> <span class="n">model</span> 
                       <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">model_color</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_INH_dependent_n_spikes</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CDK_target_value_avg_L5tt</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CDK_target_value_same_cell</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_robert</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">))</span>
        <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;INH&#39;</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;spikes per trial 0-25ms poststim&#39;</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">I</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="PWfitting.get_INH_scaling_dict"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.PWfitting.get_INH_scaling_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_INH_scaling_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">INH_scaling_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_INH_dependent_n_spikes</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">INH_scaling_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_interpolation_between_pairs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span> 
                                                                             <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span> 
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">CDK_target_value_avg_L5tt</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">INH_scaling_dict</span></div>
    
    <span class="k">def</span> <span class="nf">_plot_PSTHs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">INH</span><span class="p">,</span> <span class="n">CDK_PW</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">robert</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">models</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plottype</span> <span class="o">=</span> <span class="s1">&#39;hist&#39;</span><span class="p">):</span>
            <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span>
            <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s1">&#39;hist&#39;</span><span class="p">:</span>
                <span class="n">plotfun</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">histogram</span>
            <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">plotfun</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">st_CDK</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">ModelDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb_path1</span><span class="p">)[</span><span class="s1">&#39;CDK_PassiveTouch&#39;</span><span class="p">]</span>
            <span class="n">st_CDK</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">st_CDK</span><span class="p">,</span> <span class="n">stim</span> <span class="o">=</span> <span class="s1">&#39;D2&#39;</span><span class="p">)</span>
            <span class="n">CDK_bins</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">st_CDK</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">144</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">CDK_bins</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">245</span><span class="o">-</span><span class="mi">144</span><span class="p">,</span><span class="mi">245</span><span class="o">+</span><span class="mi">100</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">CDK_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">st_robert_control</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">ModelDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb_path2</span><span class="p">)[</span><span class="s1">&#39;spike_times&#39;</span><span class="p">]</span>
            <span class="n">st_robert_control</span> <span class="o">=</span> <span class="n">st_robert_control</span><span class="p">[</span><span class="n">st_robert_control</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C2&#39;</span><span class="p">]</span>
            <span class="n">robert_bins</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">st_robert_control</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="mi">50</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cmap</span><span class="p">[</span><span class="s1">&#39;CDK_PW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>
            <span class="n">cmap</span><span class="p">[</span><span class="s1">&#39;robert&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">CDK_PW</span><span class="p">:</span> <span class="n">plotfun</span><span class="p">(</span><span class="n">CDK_bins</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CDK_PW&#39;</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">),</span> <span class="n">colormap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>   
            <span class="k">if</span> <span class="n">robert</span><span class="p">:</span> <span class="n">plotfun</span><span class="p">(</span><span class="n">robert_bins</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;robert&#39;</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">),</span> <span class="n">colormap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>    

            <span class="k">if</span> <span class="n">models</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">selected_models</span><span class="p">:</span>  
                    <span class="n">st</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="p">)][</span><span class="s1">&#39;PW_fitting_mdb&#39;</span><span class="p">][</span><span class="s1">&#39;spike_times&#39;</span><span class="p">]</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">INH</span><span class="p">)]</span>
                    <span class="n">plotfun</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="mi">350</span><span class="p">),</span> 
                                <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">),</span> 
                                <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">colormap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span>
            <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">])</span>        
            <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">INH</span><span class="p">))</span>
            <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">fig</span>
<div class="viewcode-block" id="PWfitting.plot_PSTHs"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.PWfitting.plot_PSTHs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_PSTHs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">INH</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">2.1</span><span class="p">,</span><span class="o">.</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_PSTHs</span><span class="p">(</span><span class="n">INH</span><span class="p">,</span> <span class="n">CDK_PW</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">robert</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="get_all_L6_simulation_dbs"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_all_L6_simulation_dbs">[docs]</a><span class="k">def</span> <span class="nf">get_all_L6_simulation_dbs</span><span class="p">():</span>
    <span class="n">mdb</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">ModelDataBase</span><span class="p">(</span><span class="s1">&#39;/nas1/Data_arco/results/20190507_metaanalysis_of_L6_control_experiments&#39;</span><span class="p">)</span>
    <span class="c1"># create mdb dict</span>
    <span class="n">mdbs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdb</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">l6_config</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;l6_config&#39;</span><span class="p">]</span>
        <span class="n">selected_models</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;selected_models&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">selected_models</span><span class="p">:</span>
            <span class="n">model_run</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">morphology</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>        
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">l6_config</span><span class="o">.</span><span class="n">mdb</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;3x3_control_mdb&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;skipping &#39;</span><span class="p">,</span><span class="n">morphology</span><span class="p">,</span> <span class="n">model_run</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">mdbs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">model_run</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">morphology</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m</span>
    <span class="k">return</span> <span class="n">mdbs</span></div>
<span class="c1">#####</span>
<span class="c1"># unused so far</span>

<span class="c1"># def setup_cell_synaptic_input(cell, network_param, sim_param):</span>
<span class="c1">#     evokedNW = I.scp.NetworkMapper(cell, network_param.network, sim_param)</span>
<span class="c1">#     evokedNW.create_saved_network2()</span>
<span class="c1">#     return evokedNW</span>
<span class="c1"># </span>
<span class="c1"># def setup_cell_synaptic_input_PW(cell, param_modfuns = []):</span>
<span class="c1">#     from sumatra.parameters import NTParameterSet</span>
<span class="c1">#     network_param = get_network_param()</span>
<span class="c1">#     for fun in param_modfuns:</span>
<span class="c1">#         fun(network_param)</span>
<span class="c1">#     sim_param = NTParameterSet(dict(tStop = 2500))</span>
<span class="c1">#     setup_cell_synaptic_input(cell, network_param, sim_param)</span>
<span class="c1">#     </span>
<span class="c1"># def get_param_by_modelid(mdb, modelid):</span>
<span class="c1">#     param_names = mdb[&#39;params&#39;].index</span>
<span class="c1">#     return pdf_XY.loc[modelid][param_names]</span>
<span class="c1"># </span>
<span class="c1"># def get_cell_with_biophysics(m, modelid):</span>
<span class="c1">#     s = m[&#39;get_Simulator&#39;](m)</span>
<span class="c1">#     param = get_param_by_modelid(m, modelid)</span>
<span class="c1">#     cell, param = s.setup.get(param)</span>
<span class="c1">#     return cell   </span>
<span class="c1"># </span>
<span class="c1"># @I.dask.delayed</span>
<span class="c1"># def simulate(mdb, modelid, savemdb = None, cell_setup_fun = lambda x: x, </span>
<span class="c1">#              tStop = 300, vardt = False, return_cell = False, cell_param_mod_fun = None): </span>
<span class="c1">#     cell = get_cell_with_biophysics(mdb, modelid)</span>
<span class="c1">#     if cell_param_mod_fun is not None:</span>
<span class="c1">#         raise NotImplementedError()</span>
<span class="c1">#         cell_param_mod_fun(cell_param)</span>
<span class="c1">#     cell_setup_fun(cell)</span>
<span class="c1">#     sim = I.scp.NTParameterSet({&#39;tStart&#39;: 0.0, &#39;tStop&#39;: tStop, &#39;dt&#39;: 0.025, &#39;Vinit&#39;: -75.0, &#39;dt&#39;: 0.025, &#39;T&#39;: 34.0})</span>
<span class="c1">#     I.scp.init_neuron_run(sim, vardt = vardt)</span>
<span class="c1">#     if savemdb is not None:</span>
<span class="c1">#         savemdb.setitem(&#39;cell&#39;, cell, dumper = I.dumper_cell)</span>
<span class="c1">#         savemdb.setitem(&#39;tVec&#39;, I.np.array(cell.tVec), dumper = I.dumper_numpy_to_npz)</span>
<span class="c1">#         savemdb.setitem(&#39;vmSoma&#39;, I.np.array(cell.soma.recVList[0]), dumper = I.dumper_numpy_to_npz)</span>
<span class="c1">#     if return_cell:</span>
<span class="c1">#         return cell</span>
<span class="c1">#     else:</span>
<span class="c1">#         return I.np.array(cell.tVec), I.np.array(cell.soma.recVList[0])</span>
<span class="c1">#   </span>

<span class="c1">####################################</span>
<span class="c1"># reproduce figure 2</span>
<span class="c1">####################################</span>

<span class="c1"># general functions for saving grouped landmarks</span>
<span class="kn">import</span> <span class="nn">os</span>

<div class="viewcode-block" id="fig2_grouping_function_celltype"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2_grouping_function_celltype">[docs]</a><span class="k">def</span> <span class="nf">fig2_grouping_function_celltype</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="fig2_grouping_function_EI"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2_grouping_function_EI">[docs]</a><span class="k">def</span> <span class="nf">fig2_grouping_function_EI</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">celltype</span> <span class="o">=</span> <span class="n">fig2_grouping_function_celltype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">excitatory</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;EXC&#39;</span>
    <span class="k">elif</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">inhibitory</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;INH&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span></div>
<div class="viewcode-block" id="fig2_grouping_function_TC_IC"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2_grouping_function_TC_IC">[docs]</a><span class="k">def</span> <span class="nf">fig2_grouping_function_TC_IC</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">celltype</span> <span class="o">=</span> <span class="n">fig2_grouping_function_celltype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">celltype</span> <span class="o">==</span><span class="s1">&#39;VPM&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;TC&#39;</span>
    <span class="k">elif</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">excitatory</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;IC&#39;</span>
    <span class="k">elif</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">inhibitory</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;INH&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span></div>
    
<div class="viewcode-block" id="save_pdf_to_landmarkfile"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.save_pdf_to_landmarkfile">[docs]</a><span class="k">def</span> <span class="nf">save_pdf_to_landmarkfile</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">write_landmark_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> \
                             <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()])</span></div>

<div class="viewcode-block" id="save_fractions_of_landmark_pdf"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.save_fractions_of_landmark_pdf">[docs]</a><span class="k">def</span> <span class="nf">save_fractions_of_landmark_pdf</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> 
                                   <span class="n">fracs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">],</span>
                                   <span class="n">grouping</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig2_grouping_function_celltype</span><span class="p">,</span>
                                               <span class="n">fig2_grouping_function_EI</span><span class="p">,</span>
                                               <span class="n">fig2_grouping_function_TC_IC</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">grouping_fun</span> <span class="ow">in</span> <span class="n">grouping</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">frac</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">:</span>
            <span class="n">landmarks_pdf_frac</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span><span class="p">)</span>
            <span class="n">grouping_column</span> <span class="o">=</span> <span class="n">landmarks_pdf_frac</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">grouping_fun</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">frac</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">landmarks_pdf_frac</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_column</span><span class="p">):</span>
                <span class="n">outpath</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.landmarkAscii&#39;</span><span class="p">)</span>
                <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">write_landmark_file</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">positions</span><span class="p">))</span></div>
                
                
<span class="c1"># Panel A</span>
<span class="n">amira_view</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">viewer 0 setCameraOrientation 0.391947 0.679242 0.62049 2.37879</span>
<span class="s1">viewer 0 setCameraPosition 1509.44 802.209 -489.014</span>
<span class="s1">viewer 0 setCameraFocalDistance 1579.11</span>
<span class="s1">viewer 0 setCameraNearDistance -705.091</span>
<span class="s1">viewer 0 setCameraFarDistance 3502.41</span>
<span class="s1">viewer 0 setCameraType orthographic</span>
<span class="s1">viewer 0 setCameraHeight 2485.99</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">somaloc_bc</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> 
                            <span class="s1">&#39;reproducing_L6paper_data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;all_soma_locations&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;BC&#39;</span><span class="p">)</span>

<span class="n">somaloc_vpm</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> 
                            <span class="s1">&#39;reproducing_L6paper_data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;all_soma_locations&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;VPM&#39;</span><span class="p">)</span>

<span class="n">whole_bc_syn</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> 
                            <span class="s1">&#39;reproducing_L6paper_data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;whole_bc_embedding&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;full_bc_embedding.syn&#39;</span><span class="p">)</span>

<span class="n">whole_bc_con</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> 
                            <span class="s1">&#39;reproducing_L6paper_data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;whole_bc_embedding&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;full_bc_embedding.con&#39;</span><span class="p">)</span>

<span class="n">anatomy_folder</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> 
                            <span class="s1">&#39;reproducing_L6paper_data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;anatomy&#39;</span><span class="p">)</span>

<span class="n">amira_template_folder</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> 
                            <span class="s1">&#39;reproducing_L6paper_data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;amira_templates&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="get_fraction_of_landmarkAscii"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_fraction_of_landmarkAscii">[docs]</a><span class="k">def</span> <span class="nf">get_fraction_of_landmarkAscii</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="s1">&#39;returns fraction of landmarkAscii files defined in path&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1">#print path</span>
    <span class="n">celltype</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">read_landmark_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">positions</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">celltype</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># cannot sample from empty pdf</span>
        <span class="k">return</span> <span class="n">pdf</span> 
    <span class="k">if</span> <span class="n">frac</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pdf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pdf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_fraction_of_landmarkAscii_dir"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_fraction_of_landmarkAscii_dir">[docs]</a><span class="k">def</span> <span class="nf">get_fraction_of_landmarkAscii_dir</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="n">basedir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="s1">&#39;loads all landmarkAscii files in directory and returns dataframe containing&#39;</span>\
    <span class="s1">&#39;position and filename (without suffix i.e. without .landmarkAscii)&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;landmarkAscii&#39;</span><span class="p">):</span> <span class="k">continue</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_fraction_of_landmarkAscii</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
    <span class="c1">#if frac &gt;= 1:</span>
    <span class="c1">#        return I.pd.concat(out).sort_values(&#39;label&#39;).reset_index(drop = True)</span>
    <span class="c1">#else:</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span></div>

<span class="n">get_fraction_of_all_bc_cells</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">frac</span><span class="p">:</span> <span class="n">get_fraction_of_landmarkAscii_dir</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="n">somaloc_bc</span><span class="p">)</span>

<div class="viewcode-block" id="get_fraction_of_all_vpm_cells"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_fraction_of_all_vpm_cells">[docs]</a><span class="k">def</span> <span class="nf">get_fraction_of_all_vpm_cells</span><span class="p">(</span><span class="n">frac</span><span class="p">):</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">get_fraction_of_landmarkAscii_dir</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="n">somaloc_vpm</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;VPM_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="p">[</span><span class="n">pdf</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="s1">&#39;row&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">pdf</span></div>

<span class="n">get_fraction_of_all_cells</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">frac</span><span class="p">:</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">get_fraction_of_all_bc_cells</span><span class="p">(</span><span class="n">frac</span><span class="p">),</span> 
                                                      <span class="n">get_fraction_of_all_vpm_cells</span><span class="p">(</span><span class="n">frac</span><span class="p">)])</span>

<span class="c1">#def get_soma_positions_by_celltype(celltype):</span>
<span class="c1">#    basedir = I.os.path.dirname(__file__)</span>
<span class="c1">#    basedir = I.os.path.join(basedir, &#39;reproducing_L6paper_data&#39;)</span>
<span class="c1">#    path = I.os.path.join(basedir, celltype) + &#39;.landmarkAscii&#39;</span>
<span class="c1">#    return I.scp.read_landmark_file(path)</span>

<span class="kn">import</span> <span class="nn">singlecell_input_mapper.singlecell_input_mapper.writer</span> <span class="k">as</span> <span class="nn">writer</span>
<div class="viewcode-block" id="write_embedding_from_pdf"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.write_embedding_from_pdf">[docs]</a><span class="k">def</span> <span class="nf">write_embedding_from_pdf</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This takes a dataframe of the format:</span>
<span class="sd">    </span>
<span class="sd">                    label, position</span>
<span class="sd">                    </span>
<span class="sd">    position is a 3-tuple (x,y,z)</span>
<span class="sd">    </span>
<span class="sd">    and saves it as syn and con file at the folder fname.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">pdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cellid&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))),</span> <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">positions</span><span class="p">})</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">functionalMap</span> <span class="o">=</span> <span class="n">functionalMap_pdf</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">functionalMap</span> <span class="o">=</span> <span class="p">[(</span><span class="n">row</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">cellid</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">cellid</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">functionalMap</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()]</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_anatomical_realization_map</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.con&#39;</span><span class="p">),</span> <span class="n">functionalMap</span><span class="p">,</span> <span class="s1">&#39;test.syn&#39;</span><span class="p">)</span>
    <span class="n">synapses</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">functionalMap</span><span class="p">]</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_cell_synapse_locations</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.syn&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;synType&#39;</span><span class="p">:</span> <span class="n">synapses</span><span class="p">},</span> <span class="s1">&#39;test.syn&#39;</span><span class="p">)</span>
    <span class="n">functionalMap_pdf</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">functionalMap_pdf</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">functionalMap_pdf</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">functionalMap_pdf</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">functionalMap_pdf</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">functionalMap_pdf</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">functionalMap_pdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;cellid&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="create_whole_bc_embedding"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.create_whole_bc_embedding">[docs]</a><span class="k">def</span> <span class="nf">create_whole_bc_embedding</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;creates syn- and confile for an embedding of whole barrel cortex&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">write_embedding_from_pdf</span><span class="p">(</span><span class="n">get_fraction_of_all_cells</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;full_bc_embedding&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_cellNr"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_cellNr">[docs]</a><span class="k">def</span> <span class="nf">get_cellNr</span><span class="p">(</span><span class="n">network_param</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">celltype</span><span class="p">:</span> <span class="n">network_param</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="n">celltype</span><span class="p">]</span><span class="o">.</span><span class="n">cellNr</span> <span class="k">for</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">network_param</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span></div>

<div class="viewcode-block" id="get_landmarks_pdf_by_cellNr"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_landmarks_pdf_by_cellNr">[docs]</a><span class="k">def</span> <span class="nf">get_landmarks_pdf_by_cellNr</span><span class="p">(</span><span class="n">network_param</span><span class="p">,</span> <span class="n">landmarks_pdf_all</span><span class="p">):</span>
    <span class="n">cellnr</span> <span class="o">=</span> <span class="n">get_cellNr</span><span class="p">(</span><span class="n">network_param</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">group</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">landmarks_pdf_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)}</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cellnr</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;skipping celltype </span><span class="si">{}</span><span class="s1"> as it is not part of the barrel cortex model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">celltype</span><span class="p">)))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">cellnr</span><span class="p">[</span><span class="n">celltype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">celltype</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;specified cellnr </span><span class="si">{}</span><span class="s1"> is larger &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cellnr</span><span class="p">[</span><span class="n">celltype</span><span class="p">])</span> <span class="o">+</span> \
                  <span class="s1">&#39;than number of cells </span><span class="si">{}</span><span class="s1"> of type </span><span class="si">{}</span><span class="s1">. Using </span><span class="si">{}</span><span class="s1"> cells&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">celltype</span><span class="p">]),</span>
                                                                              <span class="n">celltype</span><span class="p">,</span>
                                                                              <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">celltype</span><span class="p">])))</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">celltype</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">celltype</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cellnr</span><span class="p">[</span><span class="n">celltype</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<span class="n">load_param_files_from_mdb</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">mdb_init_simrun_general</span><span class="o">.</span><span class="n">load_param_files_from_mdb</span>

<div class="viewcode-block" id="write_hoc_with_0_soma_diameter"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.write_hoc_with_0_soma_diameter">[docs]</a><span class="k">def</span> <span class="nf">write_hoc_with_0_soma_diameter</span><span class="p">(</span><span class="n">hocpath_in</span><span class="p">,</span> <span class="n">hocpath_out</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">resolve_mdb_path</span><span class="p">(</span><span class="n">hocpath_in</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">in_soma</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;{create soma}&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">in_soma</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">in_soma</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">in_soma</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;pt3dadd&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;pt3add</span><span class="si">{}</span><span class="s1">()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;{pt3dadd(&#39;</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,0)}&#39;</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">resolve_mdb_path</span><span class="p">(</span><span class="n">hocpath_out</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span></div>

<span class="c1"># function for saving fig2b</span>
<div class="viewcode-block" id="get_synapse_landmarks_pdf"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_synapse_landmarks_pdf">[docs]</a><span class="k">def</span> <span class="nf">get_synapse_landmarks_pdf</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span> <span class="n">sti</span><span class="p">):</span>
    <span class="n">neup</span><span class="p">,</span> <span class="n">netp</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">load_param_files_from_mdb</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span><span class="n">sti</span><span class="p">)</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">create_cell</span><span class="p">(</span><span class="n">neup</span><span class="o">.</span><span class="n">neuron</span><span class="p">)</span>
    <span class="n">evokedNW</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">NetworkMapper</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">netp</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">simParam</span><span class="o">=</span><span class="n">neup</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
    <span class="n">evokedNW</span><span class="o">.</span><span class="n">_assign_anatomical_synapses</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kn">import</span> <span class="nn">six</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">synlist</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">synapses</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">synlist</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">syn</span><span class="o">.</span><span class="n">coordinates</span><span class="p">))</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">re_init_cell</span><span class="p">()</span>
    <span class="n">evokedNW</span><span class="o">.</span><span class="n">re_init_network</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;positions&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="fig2a_anatomical_embedding"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2a_anatomical_embedding">[docs]</a><span class="k">def</span> <span class="nf">fig2a_anatomical_embedding</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span><span class="n">sti</span><span class="p">,</span><span class="n">outdir</span><span class="p">,</span> 
                               <span class="n">cells</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="n">fracs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">frac_all_cells_selected</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                               <span class="n">frac_presynaptic_cells_selected</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                               <span class="n">frac_synapses_selected</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="c1"># grab all cells </span>
    <span class="c1"># save them to all_cells/frac_0.005</span>
    <span class="k">if</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning! the specified directory already exists!&#39;</span><span class="p">)</span>
        <span class="c1">#I.shutil.rmtree(outdir)</span>
    <span class="k">if</span> <span class="n">cells</span><span class="p">:</span>
        <span class="n">neup</span><span class="p">,</span> <span class="n">netp</span> <span class="o">=</span> <span class="n">load_param_files_from_mdb</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span><span class="n">sti</span><span class="p">)</span>
        <span class="n">landmarks_pdf_all</span> <span class="o">=</span> <span class="n">get_fraction_of_all_cells</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">save_fractions_of_landmark_pdf</span><span class="p">(</span><span class="n">landmarks_pdf_all</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_cells&#39;</span><span class="p">,</span>
                                       <span class="n">fracs</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">)</span>
        <span class="c1"># I.os.makedirs(outdir + &#39;/all_cells&#39; + &#39;/selected&#39;)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_cells&#39;</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_all_cells_selected</span><span class="p">),</span>
                          <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_cells&#39;</span> <span class="o">+</span> <span class="s1">&#39;/selected&#39;</span><span class="p">)</span>         
        <span class="n">landmarks_pdf_presynaptic</span> <span class="o">=</span> <span class="n">get_landmarks_pdf_by_cellNr</span><span class="p">(</span><span class="n">netp</span><span class="p">,</span> <span class="n">landmarks_pdf_all</span><span class="p">)</span>
        <span class="n">save_fractions_of_landmark_pdf</span><span class="p">(</span><span class="n">landmarks_pdf_presynaptic</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/presynaptic_cells&#39;</span><span class="p">,</span>
                                       <span class="n">fracs</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">)</span>
        <span class="c1"># I.os.makedirs(outdir + &#39;/presynaptic_cells&#39; + &#39;/selected&#39;)        </span>
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/presynaptic_cells&#39;</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_presynaptic_cells_selected</span><span class="p">),</span>
                          <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/presynaptic_cells&#39;</span> <span class="o">+</span> <span class="s1">&#39;/selected&#39;</span><span class="p">)</span>         
        <span class="c1">#if I.os.path.exists(outdir + &#39;/anatomy&#39;):</span>
        <span class="c1">#    I.shutil.rmtree(outdir + &#39;/anatomy&#39;)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">anatomy_folder</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy&#39;</span><span class="p">)</span>   
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">amira_template_folder</span> <span class="o">+</span> <span class="s1">&#39;/Presynaptic_Cells.hx&#39;</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span>
    <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">resolve_mdb_path</span><span class="p">(</span><span class="n">neup</span><span class="o">.</span><span class="n">neuron</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy/morphology.hoc&#39;</span><span class="p">)</span>
    <span class="n">write_hoc_with_0_soma_diameter</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy/morphology.hoc&#39;</span><span class="p">,</span>
                                   <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy/morphology_no_soma.hoc&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">synapses</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">I</span><span class="o">.</span><span class="n">silence_stdout</span><span class="p">:</span>
            <span class="n">landmarks_synapses</span> <span class="o">=</span> <span class="n">get_synapse_landmarks_pdf</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span> <span class="n">sti</span><span class="p">)</span>
        <span class="n">save_fractions_of_landmark_pdf</span><span class="p">(</span><span class="n">landmarks_synapses</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_synapses&#39;</span><span class="p">,</span> <span class="n">fracs</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">)</span>
        <span class="c1"># I.os.makedirs(outdir + &#39;/all_synapses&#39; + &#39;/selected&#39;)                </span>
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_synapses&#39;</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_synapses_selected</span><span class="p">),</span>
                          <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_synapses&#39;</span> <span class="o">+</span> <span class="s1">&#39;/selected&#39;</span><span class="p">)</span>  
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">amira_template_folder</span> <span class="o">+</span> <span class="s1">&#39;/Synapses.hx&#39;</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span></div>

<span class="c1"># Panel B        </span>

<div class="viewcode-block" id="select_cells_that_spike_in_interval"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.select_cells_that_spike_in_interval">[docs]</a><span class="k">def</span> <span class="nf">select_cells_that_spike_in_interval</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">set_index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;synapse_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;synapse_type&#39;</span><span class="p">]):</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">set_index</span><span class="p">))</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pdf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]]</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="p">[((</span><span class="n">pdf</span><span class="o">&gt;=</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pdf</span><span class="o">&lt;</span><span class="n">tmax</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">cells_that_spike</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">index</span>
    <span class="n">cells_that_spike</span> <span class="o">=</span> <span class="n">cells_that_spike</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cells_that_spike</span></div>

<div class="viewcode-block" id="fig2b_functional_embedding"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2b_functional_embedding">[docs]</a><span class="k">def</span> <span class="nf">fig2b_functional_embedding</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span><span class="n">sti</span><span class="p">,</span><span class="n">outdir</span><span class="p">,</span> 
                               <span class="n">cells</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                               <span class="n">synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="n">min_time</span> <span class="o">=</span> <span class="mi">245</span><span class="p">,</span>
                               <span class="n">max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span>
                               <span class="n">fracs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">frac_presynaptic_cells_selected</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                               <span class="n">frac_synapses_selected</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="c1"># grab all cells </span>
    <span class="c1"># save them to all_cells/frac_0.005</span>
    <span class="k">if</span> <span class="n">I</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning! the specified directory already exists!&#39;</span><span class="p">)</span>
        <span class="c1"># I.shutil.rmtree(outdir)    </span>
    <span class="k">if</span> <span class="n">cells</span><span class="p">:</span>
        <span class="n">neup</span><span class="p">,</span> <span class="n">netp</span> <span class="o">=</span> <span class="n">load_param_files_from_mdb</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span><span class="n">sti</span><span class="p">)</span>
        <span class="n">landmarks_pdf_all</span> <span class="o">=</span> <span class="n">get_fraction_of_all_cells</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">landmarks_pdf_presynaptic</span> <span class="o">=</span> <span class="n">landmarks_pdf_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;cell_activation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sti</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">select_cells_that_spike_in_interval</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span>
                                                        <span class="n">min_time</span><span class="p">,</span>
                                                        <span class="n">max_time</span><span class="p">,</span>
                                                        <span class="n">set_index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;presynaptic_cell_type&#39;</span><span class="p">,</span>
                                                                     <span class="s1">&#39;cell_ID&#39;</span><span class="p">])</span> 
        <span class="n">landmarks_pdf_presynaptic</span> <span class="o">=</span> <span class="n">landmarks_pdf_presynaptic</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="c1">#save_fractions_of_landmark_pdf(landmarks_pdf_all, outdir + &#39;/all_cells&#39;,</span>
        <span class="c1">#                               fracs = fracs)</span>
        <span class="n">save_fractions_of_landmark_pdf</span><span class="p">(</span><span class="n">landmarks_pdf_presynaptic</span><span class="p">,</span> 
                                       <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/presynaptic_cells&#39;</span><span class="p">,</span>
                                       <span class="n">fracs</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">)</span>
        <span class="c1"># I.os.makedirs(outdir + &#39;/presynaptic_cells&#39; + &#39;/selected&#39;)                        </span>
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/presynaptic_cells&#39;</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_presynaptic_cells_selected</span><span class="p">),</span>
                          <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/presynaptic_cells&#39;</span> <span class="o">+</span> <span class="s1">&#39;/selected&#39;</span><span class="p">)</span>   
        <span class="c1">#if I.os.path.exists(outdir + &#39;/anatomy&#39;):</span>
        <span class="c1">#    I.shutil.rmtree(outdir + &#39;/anatomy&#39;)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">anatomy_folder</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy&#39;</span><span class="p">)</span>   
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">amira_template_folder</span> <span class="o">+</span> <span class="s1">&#39;/Presynaptic_Cells.hx&#39;</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span>
    <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">resolve_mdb_path</span><span class="p">(</span><span class="n">neup</span><span class="o">.</span><span class="n">neuron</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy/morphology.hoc&#39;</span><span class="p">)</span>
    <span class="n">write_hoc_with_0_soma_diameter</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy/morphology.hoc&#39;</span><span class="p">,</span>
                                   <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/anatomy/morphology_no_soma.hoc&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">synapses</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">I</span><span class="o">.</span><span class="n">silence_stdout</span><span class="p">:</span>
            <span class="n">landmarks_synapses</span> <span class="o">=</span> <span class="n">get_synapse_landmarks_pdf</span><span class="p">(</span><span class="n">mdb</span><span class="p">,</span> <span class="n">sti</span><span class="p">)</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">mdb</span><span class="p">[</span><span class="s1">&#39;synapse_activation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sti</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">select_cells_that_spike_in_interval</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span>
                                                        <span class="n">min_time</span><span class="p">,</span>
                                                        <span class="n">max_time</span><span class="p">,</span> 
                                                        <span class="n">set_index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;synapse_type&#39;</span><span class="p">,</span> <span class="s1">&#39;synapse_ID&#39;</span><span class="p">])</span>  
        <span class="n">landmarks_synapses</span> <span class="o">=</span> <span class="n">landmarks_synapses</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>     
        <span class="n">landmarks_synapses</span> <span class="o">=</span> <span class="n">landmarks_synapses</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
        <span class="n">save_fractions_of_landmark_pdf</span><span class="p">(</span><span class="n">landmarks_synapses</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_synapses&#39;</span><span class="p">,</span> <span class="n">fracs</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">)</span>
        <span class="c1"># I.os.makedirs(outdir + &#39;/all_synapses&#39; + &#39;/selected&#39;)                                </span>
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_synapses&#39;</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_synapses_selected</span><span class="p">),</span>
                          <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/all_synapses&#39;</span> <span class="o">+</span> <span class="s1">&#39;/selected&#39;</span><span class="p">)</span>           
        <span class="n">I</span><span class="o">.</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">amira_template_folder</span> <span class="o">+</span> <span class="s1">&#39;/Synapses.hx&#39;</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span></div>
        
<span class="c1"># Video S1</span>


<span class="c1"># Panel C</span>
<span class="nd">@I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span>
<span class="k">def</span> <span class="nf">_fig2C_data_step1</span><span class="p">(</span><span class="n">sa_pd</span><span class="p">,</span> 
        <span class="n">ongoing_min_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ongoing_max_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evoked_min_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evoked_max_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">PC</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">SCs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">celltype_group_fun</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;returns the dataframe required for reproducing plot Fig2C.</span>
<span class="sd">    Requires a pandas data frame. Use fig2C_data to compute from a dask dataframe.&#39;&#39;&#39;</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">sa_pd</span>

    <span class="k">def</span> <span class="nf">map_fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">PC</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;PC&#39;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">SCs</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;SC&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;2ndSC&#39;</span>

    <span class="n">sa</span><span class="p">[</span><span class="s1">&#39;SC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">map_fun</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">[</span><span class="s1">&#39;celltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">celltype_group_fun</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">sa</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;SC&#39;</span><span class="p">,</span> <span class="s1">&#39;celltype&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
                                                       <span class="n">min_time</span> <span class="o">=</span> <span class="n">evoked_min_time</span><span class="p">,</span> 
                                                       <span class="n">max_time</span> <span class="o">=</span> <span class="n">evoked_max_time</span><span class="p">,</span> 
                                                       <span class="n">bin_size</span> <span class="o">=</span> <span class="n">evoked_max_time</span> <span class="o">-</span> <span class="n">evoked_min_time</span><span class="p">,</span>
                                                       <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">sa</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;celltype&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
                                                       <span class="n">min_time</span> <span class="o">=</span> <span class="n">ongoing_min_time</span><span class="p">,</span> 
                                                       <span class="n">max_time</span> <span class="o">=</span> <span class="n">ongoing_max_time</span><span class="p">,</span> 
                                                       <span class="n">bin_size</span> <span class="o">=</span> <span class="n">ongoing_max_time</span> <span class="o">-</span> <span class="n">ongoing_min_time</span><span class="p">,</span>
                                                       <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># make sure ongoing activity is normalized to reflect the same timewindow as evoked activity</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">out2</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">evoked_max_time</span><span class="p">)</span><span class="o">-</span><span class="n">evoked_min_time</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ongoing_max_time</span><span class="p">)</span><span class="o">-</span><span class="n">ongoing_min_time</span><span class="p">)</span>
    <span class="n">out2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ongoing&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">out2</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">out</span><span class="p">,</span> <span class="n">out2</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_fig2C_data_step2</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> 
        <span class="n">ongoing_min_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ongoing_max_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evoked_min_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evoked_max_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">PC</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">SCs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">celltype_group_fun</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;returns the dataframe required for reproducing plot Fig2C.</span>
<span class="sd">    Requires a pandas data frame.&#39;&#39;&#39;</span>    
    <span class="n">ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">_fig2C_data_step1</span><span class="p">(</span><span class="n">d</span><span class="p">,</span>
                            <span class="n">ongoing_min_time</span> <span class="o">=</span> <span class="n">ongoing_min_time</span><span class="p">,</span>
                            <span class="n">ongoing_max_time</span> <span class="o">=</span> <span class="n">ongoing_max_time</span><span class="p">,</span>
                            <span class="n">evoked_min_time</span> <span class="o">=</span> <span class="n">evoked_min_time</span><span class="p">,</span>
                            <span class="n">evoked_max_time</span> <span class="o">=</span> <span class="n">evoked_max_time</span><span class="p">,</span>
                            <span class="n">PC</span> <span class="o">=</span> <span class="n">PC</span><span class="p">,</span>
                            <span class="n">SCs</span> <span class="o">=</span> <span class="n">SCs</span><span class="p">,</span> 
                            <span class="n">celltype_group_fun</span> <span class="o">=</span> <span class="n">celltype_group_fun</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sa</span><span class="o">.</span><span class="n">to_delayed</span><span class="p">()]</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<div class="viewcode-block" id="get_std_of_active_synapses"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_std_of_active_synapses">[docs]</a><span class="k">def</span> <span class="nf">get_std_of_active_synapses</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="s1">&#39;SC&#39;</span><span class="p">,</span> <span class="s1">&#39;2ndSC&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;std_of_total_active_synapses&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="get_mean_number_of_activations"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.get_mean_number_of_activations">[docs]</a><span class="k">def</span> <span class="nf">get_mean_number_of_activations</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_fig2C_data_step3</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
           <span class="n">celltype_renaming_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">combine_L4sp_L4ss</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">get_mean_number_of_activations</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">get_std_of_active_synapses</span><span class="p">(</span><span class="n">df</span><span class="p">)])</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">combine_L4sp_L4ss</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;L4sp&#39;</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;L4sp&#39;</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;L4ss&#39;</span><span class="p">,:]</span>    
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;L4ss&#39;</span><span class="p">)</span>    
    <span class="k">if</span> <span class="n">celltype_renaming_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">celltype_renaming_dict</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>   
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">plot_fig2C_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lv</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span><span class="c1">#lv, (name, row) in enumerate(df.iterrows()):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="o">+</span><span class="n">row</span><span class="o">.</span><span class="n">SC</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;2ndSC&#39;</span><span class="p">],</span> <span class="n">lv</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">std_of_total_active_synapses</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">capsize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#888888&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">SC</span><span class="p">,</span>  <span class="n">height</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#BBBBBB&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;2ndSC&#39;</span><span class="p">],</span>  <span class="n">height</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="o">+</span><span class="n">row</span><span class="o">.</span><span class="n">SC</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FFFFFF&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">ongoing</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ongoing</span><span class="p">],</span> <span class="p">[</span><span class="n">lv</span><span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">lv</span><span class="o">+</span><span class="mf">0.35</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>        
        <span class="c1">#ax.barh(lv, 2, 0.7, left = row.ongoing-1, color = &#39;#000000&#39;)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span><span class="mi">300</span><span class="p">)))</span>

<div class="viewcode-block" id="fig2C_data"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2C_data">[docs]</a><span class="k">def</span> <span class="nf">fig2C_data</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> 
               <span class="n">ongoing_min_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span>
               <span class="n">ongoing_max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="p">,</span>
               <span class="n">evoked_min_time</span> <span class="o">=</span> <span class="mi">245</span><span class="p">,</span>
               <span class="n">evoked_max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span>
               <span class="n">PC</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">],</span>
               <span class="n">SCs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">,</span> <span class="s1">&#39;B2&#39;</span><span class="p">,</span> <span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">,</span> <span class="s1">&#39;D3&#39;</span><span class="p">,</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;C3&#39;</span><span class="p">],</span>
               <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">celltype_renaming_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L2&#39;</span><span class="p">:</span> <span class="s1">&#39;L2PY&#39;</span><span class="p">,</span> <span class="s1">&#39;L34&#39;</span><span class="p">:</span> <span class="s1">&#39;L3PY&#39;</span><span class="p">,</span> <span class="s1">&#39;L4sp&#39;</span><span class="p">:</span> <span class="s1">&#39;L4SP&#39;</span><span class="p">,</span> 
                              <span class="s1">&#39;L4py&#39;</span><span class="p">:</span> <span class="s1">&#39;L4PY&#39;</span><span class="p">,</span> <span class="s1">&#39;L5st&#39;</span><span class="p">:</span><span class="s1">&#39;L5IT&#39;</span><span class="p">,</span> <span class="s1">&#39;L5tt&#39;</span><span class="p">:</span> <span class="s1">&#39;L5PT&#39;</span><span class="p">,</span> 
                              <span class="s1">&#39;L6cc&#39;</span><span class="p">:</span> <span class="s1">&#39;L6cc&#39;</span><span class="p">,</span> <span class="s1">&#39;L6ccinv&#39;</span><span class="p">:</span> <span class="s1">&#39;L6INV&#39;</span><span class="p">,</span> <span class="s1">&#39;L6ct&#39;</span><span class="p">:</span> <span class="s1">&#39;L6CT&#39;</span><span class="p">,</span> <span class="s1">&#39;VPM&#39;</span><span class="p">:</span> <span class="s1">&#39;VPM&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;INH&#39;</span><span class="p">:</span><span class="s1">&#39;INH&#39;</span><span class="p">},</span>
              <span class="n">combine_L4sp_L4ss</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">fillna</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">celltype_group_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sa</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">_fig2C_data_step2</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> 
                    <span class="n">ongoing_min_time</span> <span class="o">=</span> <span class="n">ongoing_min_time</span><span class="p">,</span>
                    <span class="n">ongoing_max_time</span> <span class="o">=</span> <span class="n">ongoing_max_time</span><span class="p">,</span>
                    <span class="n">evoked_min_time</span> <span class="o">=</span> <span class="n">evoked_min_time</span><span class="p">,</span>
                    <span class="n">evoked_max_time</span> <span class="o">=</span> <span class="n">evoked_max_time</span><span class="p">,</span>
                    <span class="n">PC</span> <span class="o">=</span> <span class="n">PC</span><span class="p">,</span>
                    <span class="n">SCs</span> <span class="o">=</span> <span class="n">SCs</span><span class="p">,</span>
                    <span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">,</span> 
                    <span class="n">celltype_group_fun</span> <span class="o">=</span> <span class="n">celltype_group_fun</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">_fig2C_data_step3</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
               <span class="n">celltype_renaming_dict</span> <span class="o">=</span> <span class="n">celltype_renaming_dict</span><span class="p">,</span>
               <span class="n">combine_L4sp_L4ss</span> <span class="o">=</span> <span class="n">combine_L4sp_L4ss</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fillna</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="plot_fig2C_data"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.plot_fig2C_data">[docs]</a><span class="k">def</span> <span class="nf">plot_fig2C_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> 
                    <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">xticks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span><span class="mi">300</span><span class="p">))):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lv</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span><span class="c1">#lv, (name, row) in enumerate(df.iterrows()):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="o">+</span><span class="n">row</span><span class="o">.</span><span class="n">SC</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;2ndSC&#39;</span><span class="p">],</span> <span class="n">lv</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">std_of_total_active_synapses</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">capsize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#888888&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">SC</span><span class="p">,</span>  <span class="n">height</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#BBBBBB&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;2ndSC&#39;</span><span class="p">],</span>  <span class="n">height</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">PC</span><span class="o">+</span><span class="n">row</span><span class="o">.</span><span class="n">SC</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FFFFFF&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">ongoing</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ongoing</span><span class="p">],</span> <span class="p">[</span><span class="n">lv</span><span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">lv</span><span class="o">+</span><span class="mf">0.35</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>        
        <span class="c1">#ax.barh(lv, 2, 0.7, left = row.ongoing-1, color = &#39;#000000&#39;)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xticks</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span></div>

<span class="nd">@I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span>
<span class="k">def</span> <span class="nf">_fig2C_convert_synfile_to_syn_activation</span><span class="p">(</span><span class="n">synfile_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">presyn_cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">synfile_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">synfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">synfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">presyn_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            
    <span class="n">syn_df</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">presyn_cells</span><span class="p">))</span>
    <span class="n">syn_df</span><span class="p">[</span><span class="s1">&#39;synapse_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">presyn_cells</span>
    <span class="n">syn_df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">presyn_cells</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">syn_df</span>

<div class="viewcode-block" id="fig2C_convert_synfiles_to_mock_sa"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2C_convert_synfiles_to_mock_sa">[docs]</a><span class="k">def</span> <span class="nf">fig2C_convert_synfiles_to_mock_sa</span><span class="p">(</span><span class="n">synpathlist</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This is a converter that allows to use the fig2C figure routines,</span>
<span class="sd">    which are typically used to display active synapses, to display</span>
<span class="sd">    anatomical data from syn files:</span>
<span class="sd">    </span>
<span class="sd">    In fig2C_data, specify </span>
<span class="sd">               ongoing_min_time = 0,</span>
<span class="sd">               ongoing_max_time = 10,</span>
<span class="sd">               evoked_min_time = 0,</span>
<span class="sd">               evoked_max_time = 10&#39;&#39;&#39;</span>
    
    <span class="n">delayeds</span> <span class="o">=</span> <span class="p">[</span><span class="n">_fig2C_convert_synfile_to_syn_activation</span><span class="p">(</span><span class="n">synpath</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">lv</span><span class="p">)</span> <span class="k">for</span> <span class="n">lv</span><span class="p">,</span> <span class="n">synpath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">synpathlist</span><span class="p">)]</span>
    <span class="n">mock_sa_dask_ddf</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">from_delayed</span><span class="p">(</span><span class="n">delayeds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mock_sa_dask_ddf</span></div>

<span class="c1"># fig2x active synapses by soma distance</span>
<span class="k">def</span> <span class="nf">combine_bins</span><span class="p">(</span><span class="n">bins_list</span><span class="p">):</span>
    <span class="n">bins_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bins_std_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bins_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">bins_values</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bins_list</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bins_values_std</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bins_list</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bins_out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins_values</span><span class="p">))</span>
        <span class="n">bins_std_out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins_values_std</span><span class="p">))</span>        
    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bins_out</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bins_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> \
                <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bins_std_out</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bins_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
<div class="viewcode-block" id="spatial_synapse_activation_data"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.spatial_synapse_activation_data">[docs]</a><span class="k">def</span> <span class="nf">spatial_synapse_activation_data</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> 
                                    <span class="n">celltype_group_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sa</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">min_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="mi">700</span><span class="p">,</span>
                                    <span class="n">spatial_bin_size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                                    <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">to_delayed</span><span class="p">()</span>
    
    <span class="nd">@I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span>
    <span class="k">def</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">sa_pd</span><span class="p">):</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">sa_pd</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">celltype_group_fun</span><span class="p">(</span><span class="n">sa_pd</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">I</span><span class="o">.</span><span class="n">spatial_binning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
                                                <span class="n">min_time</span> <span class="o">=</span> <span class="n">min_time</span><span class="p">,</span> 
                                                <span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span><span class="p">,</span>
                                                <span class="n">spatial_bin_size</span> <span class="o">=</span> <span class="n">spatial_bin_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bins</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">_helper</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">]</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">bins_list</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combine_bins</span><span class="p">(</span><span class="n">bins_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="fig2x_active_synapses_by_soma_distance"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.fig2x_active_synapses_by_soma_distance">[docs]</a><span class="k">def</span> <span class="nf">fig2x_active_synapses_by_soma_distance</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> 
                                           <span class="n">min_time</span> <span class="o">=</span> <span class="mi">245</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="mi">50</span><span class="p">,</span>
                                           <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spatial_bin_size</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1500</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span>
                                           <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                           <span class="n">colormap</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">color_cellTypeColorMap_L6paper_with_INH</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        
    <span class="n">bins_mean</span><span class="p">,</span> <span class="n">bins_std</span> <span class="o">=</span> <span class="n">spatial_synapse_activation_data</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span><span class="p">,</span> 
                                                      <span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">,</span> <span class="n">spatial_bin_size</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1500</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
    
    <span class="n">I</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">bins_mean</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span> 
                <span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">,</span> 
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
    <span class="n">I</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">spatial_bin_size</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">spatial_bin_size</span><span class="p">)])</span></div>

<span class="c1"># Panel D</span>
<div class="viewcode-block" id="combine_bins"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.combine_bins">[docs]</a><span class="k">def</span> <span class="nf">combine_bins</span><span class="p">(</span><span class="n">bins_list</span><span class="p">):</span>
    <span class="n">bins_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bins_std_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bins_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">bins_values</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bins_list</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bins_values_std</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bins_list</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bins_out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins_values</span><span class="p">))</span>
        <span class="n">bins_std_out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins_values_std</span><span class="p">))</span>        
    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bins_out</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bins_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> \
                <span class="n">I</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bins_std_out</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bins_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="temporal_synapse_activation_data"><a class="viewcode-back" href="../../modules/project_specific_ipynb_code.html#project_specific_ipynb_code.reproducing_L6paper.temporal_synapse_activation_data">[docs]</a><span class="k">def</span> <span class="nf">temporal_synapse_activation_data</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> 
                                    <span class="n">celltype_group_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sa</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">synapse_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">min_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">max_time</span> <span class="o">=</span> <span class="mi">245</span><span class="o">+</span><span class="mi">700</span><span class="p">,</span>
                                    <span class="n">bin_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">to_delayed</span><span class="p">()</span>
    
    <span class="nd">@I</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span>
    <span class="k">def</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">sa_pd</span><span class="p">):</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">sa_pd</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">celltype_group_fun</span><span class="p">(</span><span class="n">sa_pd</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">I</span><span class="o">.</span><span class="n">temporal_binning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
                                                <span class="n">min_time</span> <span class="o">=</span> <span class="n">min_time</span><span class="p">,</span> 
                                                <span class="n">max_time</span> <span class="o">=</span> <span class="n">max_time</span><span class="p">,</span>
                                                <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_size</span><span class="p">,</span>
                                                <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bins</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">_helper</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">]</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">bins_list</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combine_bins</span><span class="p">(</span><span class="n">bins_list</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Arco Bast, Amir Najafgholi, Maria Royo Cano, Rieke Fruengel, Matt Keaton, Bjorge Meulemeester, Omar Valerio.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>