<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>model_data_base.model_data_base &mdash; In-Silico Framework (ISF) 0.0.1 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            In-Silico Framework (ISF)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">In-Silico Framework (ISF)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">model_data_base.model_data_base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for model_data_base.model_data_base</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created on Aug 15, 2016</span>

<span class="sd">@author: arco</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">yaml</span>



<span class="k">if</span> <span class="s1">&#39;ISF_MDB_CONFIG&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ISF_MDB_CONFIG&#39;</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ISF_MDB_CONFIG&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># config = dict(backend = dict(type = &#39;sqlite_remote&#39;, url = &#39;ip:port&#39;)) </span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">backend</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;sqlite&#39;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sqlite&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.sqlite_backend.sqlite_backend</span> <span class="kn">import</span> <span class="n">SQLiteBackend</span> <span class="k">as</span> <span class="n">SQLBackend</span>
<span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sqlite_remote&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using remote sqlite backend with config </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
    <span class="kn">from</span> <span class="nn">.sqlite_backend.sqlite_remote_backend_client</span> <span class="kn">import</span> <span class="n">SQLiteBackendRemote</span> <span class="k">as</span> <span class="n">SQLBackend</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;backend must be sqlite or sqlite_remote&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.sqlite_backend.sqlite_backend</span> <span class="kn">import</span> <span class="n">InMemoryBackend</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1"># import model_data_base_register ## moved to end of file since this is a circular import</span>


<span class="kn">import</span> <span class="nn">dask.diagnostics</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">._version</span> <span class="kn">import</span> <span class="n">get_versions</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>

<div class="viewcode-block" id="slugify"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.slugify">[docs]</a><span class="k">def</span> <span class="nf">slugify</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalizes string, converts to lowercase, removes non-alpha characters,</span>
<span class="sd">    and converts spaces to hyphens.</span>
<span class="sd">    </span>
<span class="sd">    http://stackoverflow.com/questions/295135/turn-a-string-into-a-valid-filename</span>
<span class="sd">    a bit modified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^\w\s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[-\s]+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span></div>
    
<div class="viewcode-block" id="LoaderWrapper"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.LoaderWrapper">[docs]</a><span class="k">class</span> <span class="nc">LoaderWrapper</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;This is a pointer to data, which is stored elsewhere.</span>
<span class="sd">    </span>
<span class="sd">    It is used by ModelDataBase, if data is stored in a subfolder of the </span>
<span class="sd">    model_data_base.basedir folder. It is not used, if the data is stored directly</span>
<span class="sd">    in the sqlite database.</span>
<span class="sd">    </span>
<span class="sd">    The process of storing data in a subfolder is as follows:</span>
<span class="sd">    1. The subfolder is generated using the mkdtemp method</span>
<span class="sd">    2. the respective dumper puts its data there</span>
<span class="sd">    3. the dumper also saves a Loader.pickle file there. This contains an object</span>
<span class="sd">       with a get method (call it to restore the data) and everything else</span>
<span class="sd">       necessary to recover the data</span>
<span class="sd">    4. A LoaderWrapper object pointing to the datafolder with a relative</span>
<span class="sd">        path (to allow moving of the database) is saved under the respective key</span>
<span class="sd">        in the model_data_base</span>
<span class="sd">        </span>
<span class="sd">    The process of loading in the data is as follows:</span>
<span class="sd">    1. the user request it: mdb[&#39;somekey&#39;]</span>
<span class="sd">    2. the LoaderWrapper object is loaded from the backend sql database</span>
<span class="sd">    3. the Loader.pickle file in the respective folder is loaded</span>
<span class="sd">    4. the get-methdo of the unpickled object is called with the</span>
<span class="sd">        absolute path to the folder.</span>
<span class="sd">    5. the returned object is returned to the user</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="LoaderWrapper.__init__"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.LoaderWrapper.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relpath</span> <span class="o">=</span> <span class="n">relpath</span></div></div>
        
<div class="viewcode-block" id="FunctionWrapper"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.FunctionWrapper">[docs]</a><span class="k">class</span> <span class="nc">FunctionWrapper</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;This class wraps arouand an object that cannot be saved directly (e.g. </span>
<span class="sd">    using pickle) but needs an initialization function instead.</span>
<span class="sd">    </span>
<span class="sd">    To use it, </span>
<span class="sd">    1. create a function, that does not expect any argument and returns the object</span>
<span class="sd">        you want to save    </span>
<span class="sd">    2. create an instance of this class and pass your function</span>
<span class="sd">    3. save it in the database with wathever dumper you want&#39;&#39;&#39;</span>
<div class="viewcode-block" id="FunctionWrapper.__init__"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.FunctionWrapper.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span></div></div>
                
<div class="viewcode-block" id="MdbException"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.MdbException">[docs]</a><span class="k">class</span> <span class="nc">MdbException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Typical mdb errors&#39;&#39;&#39;</span>
    <span class="k">pass</span>        </div>

<span class="k">def</span> <span class="nf">_check_working_dir_clean_for_build</span><span class="p">(</span><span class="n">working_dir</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Backend method that checks, wether working_dir is suitable</span>
<span class="sd">    to build a new database there&#39;&#39;&#39;</span>
    <span class="c1">#todo: try to make dirs</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">working_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t build database: &quot;</span> \
                               <span class="o">+</span> <span class="s2">&quot;The specified working_dir is either not empty &quot;</span> \
                               <span class="o">+</span> <span class="s2">&quot;or write permission is missing. The specified path is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">working_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;Can&#39;t build database: &quot;</span> \
                               <span class="o">+</span> <span class="s2">&quot;Cannot create the directories specified in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">working_dir</span><span class="p">)</span>

<span class="c1">###methods to hide dask progress bar based on settings:</span>
<div class="viewcode-block" id="empty_context_manager"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.empty_context_manager">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">empty_context_manager</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;does nothing. is meant to replace ProgressBar, if no output is needed&#39;&#39;&#39;</span>
    <span class="k">yield</span></div>

<div class="viewcode-block" id="get_progress_bar_function"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.get_progress_bar_function">[docs]</a><span class="k">def</span> <span class="nf">get_progress_bar_function</span><span class="p">():</span>
    <span class="n">PB</span> <span class="o">=</span> <span class="n">empty_context_manager</span>    
<span class="c1">#     if settings.show_computation_progress:</span>
<span class="c1">#         PB = dask.diagnostics.ProgressBar</span>
<span class="c1">#     else:</span>
<span class="c1">#         PB = empty_context_manager</span>
    <span class="k">return</span> <span class="n">PB</span>           </div>

<div class="viewcode-block" id="SQLMetadataAccessor"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.SQLMetadataAccessor">[docs]</a><span class="k">class</span> <span class="nc">SQLMetadataAccessor</span><span class="p">():</span>
<div class="viewcode-block" id="SQLMetadataAccessor.__init__"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.SQLMetadataAccessor.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_backend</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_backend</span> <span class="o">=</span> <span class="n">sql_backend</span></div>
        
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_backend</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span>
    
<div class="viewcode-block" id="SQLMetadataAccessor.keys"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.SQLMetadataAccessor.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_backend</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div></div>

<div class="viewcode-block" id="ModelDataBase"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase">[docs]</a><span class="k">class</span> <span class="nc">ModelDataBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="ModelDataBase.__init__"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">forceload</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nocreate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">forcecreate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Class responsible for storing information, meant to be used as an interface to simulation </span>
<span class="sd">        results. If the dask backends are used to save the data, it will be out of memory,</span>
<span class="sd">        allowing larger than memory calculations.</span>
<span class="sd">        </span>
<span class="sd">        E.g. this class can be initialized in a way that after the initialization, </span>
<span class="sd">        the data can be accessed in the following way:</span>
<span class="sd">        mdb[&#39;voltage_traces&#39;]</span>
<span class="sd">        mdb[&#39;synapse_activation&#39;]</span>
<span class="sd">        mdb[&#39;spike_times&#39;]</span>
<span class="sd">        mdb[&#39;metadata&#39;]</span>
<span class="sd">        mdb[&#39;cell_activation&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Further more, it is possible to assign new elements to the database</span>
<span class="sd">        mdb[&#39;my_new_element&#39;] = my_new_element</span>
<span class="sd">        These elements are stored together with the other data in the basedir.</span>
<span class="sd">        </span>
<span class="sd">        They can be read out of the database in the following way:</span>
<span class="sd">        my_reloaded_element = mdb[&#39;my_new_element&#39;]</span>
<span class="sd">        </span>
<span class="sd">        It is possible to use tuples of strings as keys to reflect an arbitrary hierarchy.</span>
<span class="sd">        Valid keys are tuples of str or str. &quot;@&quot; ist not allowed.</span>
<span class="sd">        </span>
<span class="sd">        To read out all existing keys, use the keys()-function.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceload</span> <span class="o">=</span> <span class="n">forceload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="n">readonly</span> <span class="c1">#possible values: False, True, &#39;warning&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registered_to_path</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_db</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">errstr</span> <span class="o">=</span> <span class="s2">&quot;Did not find a database in </span><span class="si">{path}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">basedir</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="s2">&quot;A new empty database will not be created since &quot;</span><span class="o">+</span>\
                    <span class="s2">&quot;</span><span class="si">{mode}</span><span class="s2"> is set to True.&quot;</span>
            <span class="k">if</span> <span class="n">nocreate</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="n">errstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;nocreate&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">readonly</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="n">errstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;readonly&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">forcecreate</span><span class="p">:</span>
                <span class="n">_check_working_dir_clean_for_build</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_init</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registeredDumpers</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_cloudpickle</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_db</span><span class="p">()</span>                        
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_unique_id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register_this_database</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_db</span><span class="p">()</span>
            
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span> <span class="o">=</span> <span class="n">SQLBackend</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;sqlitedict.db&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span> <span class="o">=</span> <span class="n">SQLBackend</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;metadata.db&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">SQLMetadataAccessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registered_to_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_register_this_database</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_db</span><span class="p">()</span>
            <span class="c1">#self._register_this_database()            </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_metadata_if_necessary</span><span class="p">()</span>
            <span class="c1">#############################</span>
            <span class="c1"># the following code helps to smoothly transient databases of the old</span>
            <span class="c1"># format (does not implement _unique_id and metadata) to the new format.</span>
            <span class="c1"># Should be commented out soon.</span>
            <span class="c1">##############################                    </span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_unique_id</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelDataBase.in_memory"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.in_memory">[docs]</a>    <span class="k">def</span> <span class="nf">in_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load all data required for accessing data in memory. This can be helpful, if locking </span>
<span class="sd">        is taking much time, but would not be required. If in_memory has been called, no changes to </span>
<span class="sd">        the database are possible&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span> <span class="o">=</span> <span class="n">InMemoryBackend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span> <span class="o">=</span> <span class="n">InMemoryBackend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">sql_backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span> <span class="c1"># InMemoryBackend(self._sql_metadata_backend, keys = keys)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;dumper&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;just_create_mdb&#39;</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">in_memory</span><span class="p">(</span><span class="n">recursive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span></div>

    <span class="k">def</span> <span class="nf">_register_this_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;registering database with unique_id </span><span class="si">{}</span><span class="s1"> to the absolute path </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_data_base_register</span><span class="o">.</span><span class="n">register_mdb</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registered_to_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span>
        <span class="k">except</span> <span class="n">MdbException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            
    <span class="k">def</span> <span class="nf">_set_unique_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self._unique_id is already set!&quot;</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;dbcore.pickle&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">random_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> 
                                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">time</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()),</span> <span class="n">random_string</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_db</span><span class="p">()</span>      
        
<div class="viewcode-block" id="ModelDataBase.get_id"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.get_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span> </div>
        
<div class="viewcode-block" id="ModelDataBase.registerDumper"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.registerDumper">[docs]</a>    <span class="k">def</span> <span class="nf">registerDumper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dumperModule</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;caveat: make sure to provide the MODULE, not the class&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registeredDumpers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dumperModule</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="ModelDataBase.read_db"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.read_db">[docs]</a>    <span class="k">def</span> <span class="nf">read_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;sets the state of the database according to dbcore.pickle&#39;&#39;&#39;</span> 
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;dbcore.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>            </div>
            
<div class="viewcode-block" id="ModelDataBase.save_db"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.save_db">[docs]</a>    <span class="k">def</span> <span class="nf">save_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;saves the data which defines the state of this database to dbcore.pickle&#39;&#39;&#39;</span>
        <span class="c1">## things that define the state of this mdb and should be saved</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_registeredDumpers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registeredDumpers</span><span class="p">,</span> \
               <span class="s1">&#39;_unique_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id</span><span class="p">,</span>
               <span class="s1">&#39;_registered_to_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registered_to_path</span><span class="p">}</span> 
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;dbcore.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="ModelDataBase.itemexists"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.itemexists">[docs]</a>    <span class="k">def</span> <span class="nf">itemexists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Checks, if item is already in the database&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>
                
<div class="viewcode-block" id="ModelDataBase.get_mkdtemp"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.get_mkdtemp">[docs]</a>    <span class="k">def</span> <span class="nf">get_mkdtemp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;creates a directory in the model_data_base directory and </span>
<span class="sd">        returns the path&#39;&#39;&#39;</span>
        <span class="n">absolute_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">)</span> 
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>
        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">absolute_path</span><span class="p">,</span> <span class="n">relative_path</span></div>

<div class="viewcode-block" id="ModelDataBase.create_managed_folder"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.create_managed_folder">[docs]</a>    <span class="k">def</span> <span class="nf">create_managed_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">raise_</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;creates a folder in the mdb directory and saves the path in &#39;key&#39;.</span>
<span class="sd">        You can delete the folder using del mdb[key]&#39;&#39;&#39;</span>
        <span class="c1">#todo: make sure that existing key will not be overwritten</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">raise_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;Key </span><span class="si">%s</span><span class="s2"> is already set. Please use del mdb[</span><span class="si">%s</span><span class="s2">] first&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>           
            <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dumper</span> <span class="o">=</span> <span class="n">just_create_folder</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>
        
<div class="viewcode-block" id="ModelDataBase.get_managed_folder"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.get_managed_folder">[docs]</a>    <span class="k">def</span> <span class="nf">get_managed_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;deprecated!</span>
<span class="sd">        </span>
<span class="sd">        Use create_managed_folder instead&#39;&#39;&#39;</span>   
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Get_managed_folder is deprecated.  Use create_managed_folder instead.&quot;</span><span class="p">)</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_managed_folder</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="ModelDataBase.create_sub_mdb"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.create_sub_mdb">[docs]</a>    <span class="k">def</span> <span class="nf">create_sub_mdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">register</span> <span class="o">=</span> <span class="s1">&#39;as_parent&#39;</span><span class="p">,</span> <span class="n">raise_</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;creates a ModelDataBase within a ModelDataBase. Example:</span>
<span class="sd">        mdb.create_sub_mdb(&#39;my_sub_database&#39;)</span>
<span class="sd">        mdb[&#39;my_sub_database&#39;][&#39;sme_key&#39;] = [&#39;some_value&#39;]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">register</span> <span class="o">==</span> <span class="s1">&#39;as_parent&#39;</span><span class="p">:</span>
            <span class="c1">##todo</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">raise_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;Key </span><span class="si">%s</span><span class="s2"> is already set. Please use del mdb[</span><span class="si">%s</span><span class="s2">] first&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dumper</span> <span class="o">=</span> <span class="n">just_create_mdb</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="ModelDataBase.get_sub_mdb"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.get_sub_mdb">[docs]</a>    <span class="k">def</span> <span class="nf">get_sub_mdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span> <span class="n">register</span> <span class="o">=</span> <span class="s1">&#39;as_parent&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;deprecated!</span>
<span class="sd">        </span>
<span class="sd">        Use create_sub_mdb instead&#39;&#39;&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;get_sub_mdb is deprecated.  Use create_sub_mdb instead.&quot;</span><span class="p">)</span>         
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_sub_mdb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">register</span> <span class="o">=</span> <span class="n">register</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;items can be retrieved from the ModelDataBase using this syntax:</span>
<span class="sd">        item = my_model_data_base[key]&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="c1"># general case                </span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">LoaderWrapper</span><span class="p">):</span>
                <span class="n">dummy</span> <span class="o">=</span> <span class="n">LoaderDumper</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">dummy</span><span class="o">.</span><span class="n">relpath</span><span class="p">))</span> 
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">FunctionWrapper</span><span class="p">):</span>
                <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">fun</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">dummy</span>   
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  
            <span class="c1"># special case: if we have nested mdbs, allow accessing it with</span>
            <span class="c1"># mdb[key_in_parent_mdb, key_in_child_mdb] instead of forcing</span>
            <span class="c1"># mdb[key_in_parent_mdb][key_in_child_mdb]</span>
            <span class="n">existing_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            
            <span class="k">def</span> <span class="nf">str_to_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">x</span>
                
            <span class="n">existing_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">str_to_tuple</span><span class="p">,</span> <span class="n">existing_keys</span><span class="p">))</span>            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">existing_keys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">lv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="p">[:</span><span class="n">lv</span><span class="p">]</span> <span class="ow">in</span> <span class="n">existing_keys</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">arg</span><span class="p">[:</span><span class="n">lv</span><span class="p">]][</span><span class="n">arg</span><span class="p">[</span><span class="n">lv</span><span class="p">:]]</span>
            <span class="k">raise</span>    
    
    <span class="k">def</span> <span class="nf">_check_writing_privilege</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;raises MdbException, if we don&#39;t have permission to write to key &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;DB is in readonly mode. Blocked writing attempt to key </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="c1">#this exists, so jupyter notebooks will not crash when they try to write something</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">is</span> <span class="s1">&#39;warning&#39;</span><span class="p">:</span> 
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;DB is in readonly mode. Blocked writing attempt to key </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;Readonly attribute should be True, False or &#39;warning, but is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_find_dumper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;finds the dumper of a given item.&#39;&#39;&#39;</span>
        <span class="n">dumper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registeredDumpers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span> <span class="ow">or</span> <span class="n">d</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">dumper</span> <span class="o">=</span> <span class="n">d</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">dumper</span>
    
    <span class="k">def</span> <span class="nf">_check_key_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;raises an MdbException, if key is invalid&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
        <span class="c1"># make sure hierarchy mimics folder structure:</span>
        <span class="c1"># (parent, child) can only exist, if parent is not already set to</span>
        <span class="c1"># some value</span>
        <span class="n">existing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">k</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="c1"># make sure, first elements of the key are not used already,</span>
        <span class="c1"># e.g. if we want to set (&#39;A&#39;, &#39;1&#39;), we have to make sure that </span>
        <span class="c1"># (&#39;A&#39;) is not already set</span>
        <span class="k">for</span> <span class="n">current_key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">key</span><span class="p">[:</span><span class="n">lv</span><span class="p">]</span> <span class="k">for</span> <span class="n">lv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))]:</span>
            <span class="k">if</span> <span class="n">current_key</span> <span class="ow">in</span> <span class="n">existing_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;Cannot set </span><span class="si">{key1}</span><span class="s2">. Conflicting key is </span><span class="si">{key2}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key1</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">current_key</span><span class="p">))</span>
        <span class="c1"># do it vice versa</span>
        <span class="k">for</span> <span class="n">current_key</span> <span class="ow">in</span> <span class="n">existing_keys</span><span class="p">:</span>               
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_key</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">current_key</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)]:</span>
                <span class="k">raise</span> <span class="n">MdbException</span><span class="p">(</span><span class="s2">&quot;Cannot set </span><span class="si">{key1}</span><span class="s2">. Conflicting key is </span><span class="si">{key2}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key1</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">current_key</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_get_savedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns directory in which the data is stored. Returns None if dumper is self.&#39;&#39;&#39;</span>
        <span class="n">old_folder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_key_exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">LoaderWrapper</span><span class="p">):</span>
                <span class="n">old_folder</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">relpath</span>
        <span class="k">return</span> <span class="n">old_folder</span>
    
<div class="viewcode-block" id="ModelDataBase.check_if_key_exists"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.check_if_key_exists">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_key_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>        
            
        <span class="n">existing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">k</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">existing_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>
        
    <span class="k">def</span> <span class="nf">_setitem_no_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">dumper</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;private API! Used for storing data. Writing metadata needs to be done</span>
<span class="sd">        in addition!&#39;&#39;&#39;</span>
        <span class="c1">#if dumper is &#39;self&#39;: store in this DB</span>
        <span class="k">if</span> <span class="n">dumper</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                
        <span class="c1">#if dumper is something else: </span>
        <span class="c1">#generate temp directory, save the object in that directory using dump()</span>
        <span class="c1">#wrap the relative path to an LoaderWrapper object and save it to the </span>
        <span class="c1">#internal database</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basedir_absolute</span><span class="p">,</span> <span class="n">basedir_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mkdtemp</span><span class="p">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dumper</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">basedir_absolute</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An error occured. Tidy up. Please do not interrupt.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">basedir_absolute</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not delete folder </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basedir_absolute</span><span class="p">))</span>
                <span class="k">raise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">LoaderWrapper</span><span class="p">(</span><span class="n">basedir_relative</span><span class="p">)</span>
            
    
<div class="viewcode-block" id="ModelDataBase.setitem"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.setitem">[docs]</a>    <span class="k">def</span> <span class="nf">setitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Allows to set items. Compared to the mdb[&#39;some_keys&#39;] = my_item syntax,</span>
<span class="sd">        this method allows more control over how the item is stored in the database.</span>
<span class="sd">        </span>
<span class="sd">        key: key</span>
<span class="sd">        item: item that should be saved</span>
<span class="sd">        dumper= dumper module to use, e.g. model_data_base.IO.LoaderDumper.numpy_to_npy</span>
<span class="sd">            If dumper is not set, the default dumper is used</span>
<span class="sd">        **kwargs: other keyword arguments that should be passed to the dumper</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
        
        <span class="c1">#make sure, key is valid and not conflicting with other keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_key_validity</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="c1">#extract dumper from kwargs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;dumper&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dumper&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dumper&#39;</span><span class="p">]</span>
                    
        <span class="c1">#check if we have writing privilege</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_writing_privilege</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="c1"># check if there is already a subdirectory assigned to this key. </span>
        <span class="c1"># If so: store folder to delete it after new item is set.</span>
        <span class="n">old_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_savedir</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                                
        <span class="c1">#find dumper</span>
        <span class="k">if</span> <span class="n">dumper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_dumper</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">dumper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="c1">#write data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setitem_no_metadata</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">dumper</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1">#delete old data directory        </span>
        <span class="k">if</span> <span class="n">old_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_robust_rmtree</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">old_folder</span><span class="p">))</span>
            
        <span class="c1">#write metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_metadata_for_new_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dumper</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">_write_metadata_for_new_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dumper</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;this is private API and should only</span>
<span class="sd">        be called from within ModelDataBase.</span>
<span class="sd">        Can othervise be destructive!!!&#39;&#39;&#39;</span>        
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span><span class="n">dumper</span><span class="p">):</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="n">LoaderDumper</span><span class="o">.</span><span class="n">get_dumper_string_by_dumper_module</span><span class="p">(</span><span class="n">dumper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumper</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dumper&#39;</span><span class="p">:</span> <span class="n">dumper</span><span class="p">,</span>
               <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()),</span> 
               <span class="s1">&#39;metadata_creation_time&#39;</span><span class="p">:</span> <span class="s1">&#39;together_with_new_key&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;conda_list&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_conda_list</span><span class="p">(),</span>
               <span class="s1">&#39;module_versions&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_module_versions</span><span class="p">(),</span>
               <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_history</span><span class="p">(),</span>
               <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_hostname</span><span class="p">()}</span>

        <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">VC</span><span class="o">.</span><span class="n">get_git_version</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_git_version</span><span class="p">()[</span><span class="s1">&#39;dirty&#39;</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The database source folder has uncommitted changes!&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_delete_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;this is private API and should only</span>
<span class="sd">        be called from within ModelDataBase.</span>
<span class="sd">        Can othervise be destructive!!!&#39;&#39;&#39;</span>        
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>    

    <span class="k">def</span> <span class="nf">_detect_dumper_string_of_existing_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">dumper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumper</span><span class="p">,</span> <span class="n">LoaderWrapper</span><span class="p">):</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="n">LoaderDumper</span><span class="o">.</span><span class="n">get_dumper_string_by_savedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">dumper</span><span class="o">.</span><span class="n">relpath</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="s1">&#39;self&#39;</span>
        <span class="k">return</span> <span class="n">dumper</span>

    <span class="k">def</span> <span class="nf">_get_dumper_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">dumper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumper</span><span class="p">,</span> <span class="n">LoaderWrapper</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">dumper</span><span class="o">.</span><span class="n">relpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>        

    <span class="k">def</span> <span class="nf">_write_metadata_for_existing_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;this is private API and should only</span>
<span class="sd">            be called from within ModelDataBase.</span>
<span class="sd">            Can othervise be destructive as it overwrites metadata!!!&#39;&#39;&#39;</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_dumper_string_of_existing_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">dumper</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dumper_folder</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
                <span class="n">time</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
            
            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dumper&#39;</span><span class="p">:</span> <span class="n">dumper</span><span class="p">,</span> \
                   <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> \
                   <span class="s1">&#39;metadata_creation_time&#39;</span><span class="p">:</span> <span class="s1">&#39;post_hoc&#39;</span><span class="p">}</span>
            
            <span class="k">if</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_git_version</span><span class="p">()[</span><span class="s1">&#39;dirty&#39;</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The database source folder has uncommitted changes!&#39;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
    
    <span class="k">def</span> <span class="nf">_update_metadata_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;ckecks, wehter metadata is missing. Is so, it tries to estimate metadata, i.e. it sets the</span>
<span class="sd">        time based on the timestamp of the files. When metadata is created in that way,</span>
<span class="sd">        the field `metadata_creation_time` is set to `post_hoc`&#39;&#39;&#39;</span>
        <span class="n">keys_in_mdb_without_metadata</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_in_mdb_without_metadata</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating metadata for key </span><span class="si">{key}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_metadata_for_existing_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
               
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;items can be set using my_model_data_base[key] = item</span>
<span class="sd">        This saves the data with the default dumper.</span>
<span class="sd">        </span>
<span class="sd">        A more elaborate version of this function, which allows more </span>
<span class="sd">        control on how the data is stored in the database is </span>
<span class="sd">        ModelDataBase.setitem.&#39;&#39;&#39;</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">dumper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_robust_rmtree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start deleting </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;The folder &#39;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39; was registered as belonging to &#39;</span> <span class="o">+</span> \
                  <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. I tried to delete this folder, because the corresponding key was overwritten. &#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;Could not delete anything, because folder did not exist in the first place. I just carry on ...&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done deleting </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

            
    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;items can be deleted using del my_model_data_base[key]&#39;&#39;&#39;</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">LoaderWrapper</span><span class="p">):</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robust_rmtree</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span><span class="n">dummy</span><span class="o">.</span><span class="n">relpath</span><span class="p">)))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_metadata</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_write_metadata_for_new_dumper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_dumper</span><span class="p">):</span>
        <span class="c1">#update metadata</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span><span class="n">new_dumper</span><span class="p">):</span>
            <span class="n">dumper</span> <span class="o">=</span> <span class="n">LoaderDumper</span><span class="o">.</span><span class="n">get_dumper_string_by_dumper_module</span><span class="p">(</span><span class="n">new_dumper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dumper</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">pass</span>
                
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;dumper_updates&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dumper_update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dumper&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;module_versions&#39;</span><span class="p">]}]</span>
        <span class="n">new_dumper</span> <span class="o">=</span> <span class="n">LoaderDumper</span><span class="o">.</span><span class="n">get_dumper_string_by_dumper_module</span><span class="p">(</span><span class="n">new_dumper</span><span class="p">)</span>
        <span class="n">dumper_update</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dumper&#39;</span><span class="p">:</span> <span class="n">new_dumper</span><span class="p">,</span>
               <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()),</span>
               <span class="s1">&#39;conda_list&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_conda_list</span><span class="p">(),</span>
               <span class="s1">&#39;module_versions&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_module_versions</span><span class="p">(),</span>
               <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_history</span><span class="p">(),</span>
               <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_hostname</span><span class="p">()}</span>
        <span class="n">dumper_update</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">VC</span><span class="o">.</span><span class="n">get_git_version</span><span class="p">())</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dumper_update&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dumper_update</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dumper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dumper</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
        
<div class="viewcode-block" id="ModelDataBase.change_dumper"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.change_dumper">[docs]</a>    <span class="k">def</span> <span class="nf">change_dumper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_dumper</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VC</span><span class="o">.</span><span class="n">get_git_version</span><span class="p">()[</span><span class="s1">&#39;dirty&#39;</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The database source folder has uncommitted changes!&#39;</span><span class="p">)</span>
                    
        <span class="k">if</span> <span class="n">new_dumper</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        
        <span class="n">old_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_savedir</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setitem_no_metadata</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">new_dumper</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_robust_rmtree</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">old_folder</span><span class="p">))</span>
        
        <span class="c1">#update metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_metadata_for_new_dumper</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">new_dumper</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="ModelDataBase.maybe_calculate"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.maybe_calculate">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This function returns the corresponding value of key,</span>
<span class="sd">        if it is already in the database. If it is not in the database,</span>
<span class="sd">        it calculates the value by calling fun, adds this value to the</span>
<span class="sd">        database and returns the value.</span>
<span class="sd">        </span>
<span class="sd">        key: key on which the item can be accessed / should be accessible in the database</span>
<span class="sd">        fun: function expects no parameters (e.g. lambda: &#39;hello world&#39;) </span>
<span class="sd">        force_calculation =: if set to True, the value will allways be recalculated</span>
<span class="sd">            If there is already an entry in the database with the same key, it will</span>
<span class="sd">            be overwritten</span>
<span class="sd">        **kwargs: attributes, that get passed to ModelDataBase.setitem</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">        #value is calculated, since it is the first call and not in the database</span>
<span class="sd">        mdb.maybe_calculate(&#39;knok_knok&#39;, lambda: &#39;whos there?&#39;, dumper = &#39;self&#39;)</span>
<span class="sd">        &gt; &#39;whos there?&#39;</span>
<span class="sd">        </span>
<span class="sd">        #value is taken from the database, since it is already stored</span>
<span class="sd">        mdb.maybe_calculate(&#39;knok_knok&#39;, lambda: &#39;whos there?&#39;, dumper = &#39;self&#39;)</span>
<span class="sd">        &gt; &#39;whos there?&#39;        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="s1">&#39;force_calculation&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">force_calculation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;force_calculation&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;force_calculation&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force_calculation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force_calculation</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">get_progress_bar_function</span><span class="p">()():</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">fun</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>    </div>
        
<div class="viewcode-block" id="ModelDataBase.keys"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns the keys of the database&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1">###</span></div>
    
<div class="viewcode-block" id="ModelDataBase.get_readonly"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.ModelDataBase.get_readonly">[docs]</a>    <span class="k">def</span> <span class="nf">get_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns a new ModelDataBase, which is readonly.</span>
<span class="sd">        </span>
<span class="sd">        Usecase: If you want to use the database for distributed computations, which only require</span>
<span class="sd">        loading in data, a readonoly database can speed things up as some checks can be ommitted&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">ModelDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">forceload</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">nocreate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">forcecreate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">,</span> <span class="n">InMemoryBackend</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_sql_backend&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">,</span> 
                     <span class="s1">&#39;_sql_metadata_backend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_metadata_backend</span><span class="p">,</span> 
                     <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">dict_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">{})</span></div>
    
<div class="viewcode-block" id="RegisteredFolder"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.RegisteredFolder">[docs]</a><span class="k">class</span> <span class="nc">RegisteredFolder</span><span class="p">(</span><span class="n">ModelDataBase</span><span class="p">):</span>
<div class="viewcode-block" id="RegisteredFolder.__init__"><a class="viewcode-back" href="../../source/model_data_base.html#model_data_base.model_data_base.RegisteredFolder.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">ModelDataBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">forcecreate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dumper</span> <span class="o">=</span> <span class="n">just_create_folder</span><span class="p">)</span>
        <span class="n">dumper</span> <span class="o">=</span> <span class="n">just_create_folder</span>
        <span class="n">dumper</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_backend</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LoaderWrapper</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span> <span class="o">=</span> <span class="kc">None</span></div></div>
        
    

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mdbopen</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_module_versions</span>
<span class="kn">from</span> <span class="nn">.IO</span> <span class="kn">import</span> <span class="n">LoaderDumper</span>

<span class="kn">from</span> <span class="nn">.IO.LoaderDumper</span> <span class="kn">import</span> <span class="n">just_create_folder</span>
<span class="kn">from</span> <span class="nn">.IO.LoaderDumper</span> <span class="kn">import</span> <span class="n">just_create_mdb</span>
<span class="kn">from</span> <span class="nn">.IO.LoaderDumper</span> <span class="kn">import</span> <span class="n">to_pickle</span>
<span class="kn">from</span> <span class="nn">.IO.LoaderDumper</span> <span class="kn">import</span> <span class="n">to_cloudpickle</span>
                      
<span class="n">VC</span> <span class="o">=</span> <span class="n">_module_versions</span><span class="o">.</span><span class="n">version_cached</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">model_data_base_register</span>
<span class="c1"># get_versions_cache = get_versions()</span>
<span class="c1"># module_versions_cache = _module_versions.get_module_versions()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Arco Bast, Amir Najafgholi, Maria Royo Cano, Rieke Fruengel, Matt Keaton, Bjorge Meulemeester, Omar Valerio.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>